<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’• Smart Learning AI - Há»‡ thá»‘ng há»c táº­p thÃ´ng minh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCGAvJ8du5Xcp56ac4zPGLr2jcWPFr_qck",
            authDomain: "quiz-ai-system.firebaseapp.com",
            projectId: "quiz-ai-system",
            storageBucket: "quiz-ai-system.firebasestorage.app",
            messagingSenderId: "823165200254",
            appId: "1:823165200254:web:3e67eb0ccd1f46da5ab52f",
            measurementId: "G-16MBCN7DX6"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        console.log('ğŸ”¥ Firebase initialized successfully');
    </script>
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect { backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.1); }
        .float-animation { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        .glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
        .typing::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .sparkle { position: relative; overflow: hidden; }
        .sparkle::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); animation: sparkle 3s infinite; }
        @keyframes sparkle { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        
        /* Fix input field text visibility */
        input, textarea, select {
            color: white !important;
            background-color: rgba(255,255,255,0.1) !important;
        }
        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.6) !important;
        }
        input:focus, textarea:focus, select:focus {
            color: white !important;
            background-color: rgba(255,255,255,0.15) !important;
        }
        
        /* Smooth animations */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced chat styling */
        .chat-message {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            max-width: 100%;
            overflow-wrap: break-word;
        }
        
        /* Smooth scrolling */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* Photo scanner container fix */
        .photo-container {
            max-width: 100%;
            overflow: hidden;
        }
        
        .photo-preview-img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    
    <!-- Floating Hearts Background -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-20 left-10 text-pink-300 text-2xl float-animation" style="animation-delay: 0s;">ğŸ’•</div>
        <div class="absolute top-40 right-20 text-purple-300 text-xl float-animation" style="animation-delay: 2s;">âœ¨</div>
        <div class="absolute bottom-40 left-20 text-blue-300 text-2xl float-animation" style="animation-delay: 4s;">ğŸŒŸ</div>
        <div class="absolute bottom-20 right-10 text-pink-300 text-xl float-animation" style="animation-delay: 1s;">ğŸ¯</div>
        <div class="absolute top-60 left-1/2 text-yellow-300 text-2xl float-animation" style="animation-delay: 3s;">ğŸ§ </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full text-white shadow-2xl glow">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4 float-animation">ğŸ§ âœ¨</div>
                <h1 class="text-3xl font-bold mb-2 sparkle">Smart Learning AI</h1>
                <p class="text-blue-200">Há»‡ thá»‘ng há»c táº­p thÃ´ng minh dÃ nh cho 2 ngÆ°á»i ğŸ’•</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showUserLogin()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-user-graduate mr-2"></i> ÄÄƒng nháº­p há»c viÃªn
                </button>
                <button onclick="showAdminLogin()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-crown mr-2"></i> ÄÄƒng nháº­p giáº£ng viÃªn
                </button>
            </div>
        </div>
    </div>

    <!-- User Login -->
    <div id="user-login" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full text-white shadow-2xl glow">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">ğŸ‘©â€ğŸ“ğŸ‘¨â€ğŸ“</div>
                <h2 class="text-2xl font-bold mb-2">ChÃ o má»«ng há»c viÃªn!</h2>
                <p class="text-blue-200">Nháº­p tÃªn Ä‘á»ƒ báº¯t Ä‘áº§u hÃ nh trÃ¬nh há»c táº­p</p>
            </div>
            
            <form onsubmit="userLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">
                        <i class="fas fa-user mr-2"></i>TÃªn cá»§a báº¡n
                    </label>
                    <input type="text" id="user-name" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent text-white placeholder-white/60"
                           placeholder="Nháº­p tÃªn cá»§a báº¡n..." style="color: white !important; background-color: rgba(255,255,255,0.1) !important;">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-rocket mr-2"></i>Báº¯t Ä‘áº§u há»c táº­p
                </button>
                
                <button type="button" onclick="backToMain()" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay láº¡i
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full text-white shadow-2xl glow">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">ğŸ‘¨â€ğŸ«âœ¨</div>
                <h2 class="text-2xl font-bold mb-2">ChÃ o má»«ng giáº£ng viÃªn!</h2>
                <p class="text-blue-200">ÄÄƒng nháº­p Ä‘á»ƒ quáº£n lÃ½ há»‡ thá»‘ng</p>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">
                        <i class="fas fa-key mr-2"></i>Máº­t kháº©u
                    </label>
                    <input type="password" id="admin-password" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-white/60"
                           placeholder="Nháº­p máº­t kháº©u..." style="color: white !important; background-color: rgba(255,255,255,0.1) !important;">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i>ÄÄƒng nháº­p
                </button>
                
                <button type="button" onclick="backToMain()" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay láº¡i
                </button>
            </form>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="hidden min-h-screen">
        <!-- Top Navigation -->
        <nav class="glass-effect text-white p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl">ğŸ§ âœ¨</div>
                    <h1 class="text-xl font-bold">Smart Learning AI</h1>
                    <span class="text-sm bg-white/20 px-3 py-1 rounded-full">
                        Xin chÃ o, <span id="current-user-name" class="font-semibold">Há»c viÃªn</span>! ğŸ’•
                    </span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="user-streak" class="bg-yellow-500/20 px-3 py-1 rounded-full text-sm">
                        ğŸ”¥ Streak: <span id="streak-count">0</span> ngÃ y
                    </div>
                    <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/40 px-4 py-2 rounded-xl transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>ÄÄƒng xuáº¥t
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto p-6 max-w-7xl">
            
            <!-- Welcome Section with AI Greeting -->
            <div class="glass-effect rounded-3xl p-8 mb-8 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">
                            <span id="greeting-text">ChÃ o báº¡n!</span> 
                            <span class="text-pink-300">âœ¨</span>
                        </h2>
                        <p id="ai-motivational-message" class="text-blue-200 text-lg typing">
                            AI Ä‘ang chuáº©n bá»‹ lá»i Ä‘á»™ng viÃªn cho báº¡n...
                        </p>
                    </div>
                    <div class="text-6xl float-animation">ğŸ¯ğŸ’«</div>
                </div>
            </div>

            <!-- Quick Actions Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                
                <!-- AI Study Assistant -->
                <div onclick="openAIAssistant()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ¤–ğŸ’¡</div>
                    <h3 class="text-xl font-bold mb-2 text-center">AI Gia sÆ° thÃ´ng minh</h3>
                    <p class="text-blue-200 text-center">Trá»£ lÃ½ AI cÃ¡ nhÃ¢n giáº£i Ä‘Ã¡p má»i tháº¯c máº¯c</p>
                </div>

                <!-- Smart Quiz Mode -->
                <div onclick="startSmartQuiz()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ§©âš¡</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Quiz thÃ´ng minh</h3>
                    <p class="text-blue-200 text-center">AI tá»± Ä‘á»™ng táº¡o cÃ¢u há»i phÃ¹ há»£p vá»›i trÃ¬nh Ä‘á»™</p>
                </div>

                <!-- Photo Scanner -->
                <div onclick="openPhotoScanner()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ“¸ğŸ”</div>
                    <h3 class="text-xl font-bold mb-2 text-center">QuÃ©t áº£nh há»c táº­p</h3>
                    <p class="text-blue-200 text-center">Chá»¥p áº£nh bÃ i táº­p, AI sáº½ giáº£i thÃ­ch chi tiáº¿t</p>
                </div>

                <!-- Study Together -->
                <div onclick="openStudyTogether()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ‘«ğŸ’•</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Há»c cÃ¹ng nhau</h3>
                    <p class="text-blue-200 text-center">ThÃ¡ch Ä‘áº¥u vÃ  há»c táº­p cÃ¹ng báº¡n bÃ¨</p>
                </div>

                <!-- Knowledge Map -->
                <div onclick="openKnowledgeMap()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ—ºï¸ğŸŒŸ</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Báº£n Ä‘á»“ kiáº¿n thá»©c</h3>
                    <p class="text-blue-200 text-center">Theo dÃµi tiáº¿n trÃ¬nh há»c táº­p trá»±c quan</p>
                </div>

                <!-- Voice Assistant -->
                <div onclick="openVoiceAssistant()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ¤ğŸ—£ï¸</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Trá»£ lÃ½ giá»ng nÃ³i</h3>
                    <p class="text-blue-200 text-center">Há»c báº±ng giá»ng nÃ³i, tÆ°Æ¡ng tÃ¡c tá»± nhiÃªn</p>
                </div>

            </div>

            <!-- Current Activity Section -->
            <div id="current-activity" class="glass-effect rounded-3xl p-8 text-white">
                <h3 class="text-2xl font-bold mb-6 text-center">ğŸ¯ Hoáº¡t Ä‘á»™ng hiá»‡n táº¡i</h3>
                <div class="text-center text-blue-200">
                    <div class="text-4xl mb-4">ğŸŒŸ</div>
                    <p>Chá»n má»™t hoáº¡t Ä‘á»™ng Ä‘á»ƒ báº¯t Ä‘áº§u hÃ nh trÃ¬nh há»c táº­p cá»§a báº¡n!</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <!-- Admin Navigation -->
        <nav class="glass-effect text-white p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl">ğŸ‘¨â€ğŸ«âœ¨</div>
                    <h1 class="text-xl font-bold">Báº£ng Ä‘iá»u khiá»ƒn giáº£ng viÃªn</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span class="text-sm bg-white/20 px-3 py-1 rounded-full">ChÃ o má»«ng, Giáº£ng viÃªn!</span>
                    <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/40 px-4 py-2 rounded-xl transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>ÄÄƒng xuáº¥t
                    </button>
                </div>
            </div>
        </nav>

        <!-- Admin Content -->
        <div class="container mx-auto p-6 max-w-7xl">
            
            <!-- Admin Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-blue-300" id="total-questions">0</div>
                    <div class="text-sm text-blue-200">Tá»•ng cÃ¢u há»i</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-green-300" id="active-users">0</div>
                    <div class="text-sm text-blue-200">Há»c viÃªn hoáº¡t Ä‘á»™ng</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-yellow-300" id="ai-interactions">0</div>
                    <div class="text-sm text-blue-200">TÆ°Æ¡ng tÃ¡c AI</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-pink-300">95%</div>
                    <div class="text-sm text-blue-200">Hiá»‡u quáº£ há»c táº­p</div>
                </div>
            </div>

            <!-- Admin Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                
                <!-- AI Content Generator -->
                <div onclick="openAIContentGenerator()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ¤–ğŸ“</div>
                    <h3 class="text-xl font-bold mb-2 text-center">AI Táº¡o ná»™i dung</h3>
                    <p class="text-blue-200 text-center">Tá»± Ä‘á»™ng táº¡o cÃ¢u há»i tá»« áº£nh vÃ  vÄƒn báº£n</p>
                </div>

                <!-- Smart Analytics -->
                <div onclick="openSmartAnalytics()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ“ŠğŸ§ </div>
                    <h3 class="text-xl font-bold mb-2 text-center">PhÃ¢n tÃ­ch thÃ´ng minh</h3>
                    <p class="text-blue-200 text-center">AI phÃ¢n tÃ­ch tiáº¿n trÃ¬nh há»c táº­p cá»§a há»c viÃªn</p>
                </div>

                <!-- Learning Path Designer -->
                <div onclick="openLearningPathDesigner()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ›¤ï¸â­</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Thiáº¿t káº¿ lá»™ trÃ¬nh</h3>
                    <p class="text-blue-200 text-center">Táº¡o lá»™ trÃ¬nh há»c táº­p cÃ¡ nhÃ¢n hÃ³a</p>
                </div>

                <!-- Question Bank Manager -->
                <div onclick="openQuestionBankManager()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ¦ğŸ“š</div>
                    <h3 class="text-xl font-bold mb-2 text-center">NgÃ¢n hÃ ng cÃ¢u há»i</h3>
                    <p class="text-blue-200 text-center">Quáº£n lÃ½ vÃ  tá»• chá»©c cÃ¢u há»i thÃ´ng minh</p>
                </div>

                <!-- Student Monitor -->
                <div onclick="openStudentMonitor()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">ğŸ‘€ğŸ“ˆ</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Theo dÃµi há»c viÃªn</h3>
                    <p class="text-blue-200 text-center">GiÃ¡m sÃ¡t real-time hoáº¡t Ä‘á»™ng há»c táº­p</p>
                </div>

                <!-- AI Settings -->
                <div onclick="openAISettings()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">âš™ï¸ğŸ¤–</div>
                    <h3 class="text-xl font-bold mb-2 text-center">CÃ i Ä‘áº·t AI</h3>
                    <p class="text-blue-200 text-center">Äiá»u chá»‰nh thÃ´ng sá»‘ AI vÃ  API keys</p>
                </div>

            </div>

        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="glass-effect rounded-3xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto text-white">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let aiConversationHistory = [];
        let aiPersonalityMemory = {
            creator: "Nguyá»…n HÃ n NhÆ°",
            mother: "QuyÃªn", 
            userPreferences: {},
            conversationContext: [],
            personalityTraits: [
                "thÃ´ng minh vÃ  hiá»ƒu biáº¿t",
                "thÃ¢n thiá»‡n vÃ  áº¥m Ã¡p nhÆ° máº¹ QuyÃªn",
                "kiÃªn nháº«n vÃ  khuyáº¿n khÃ­ch",
                "cÃ³ trÃ­ nhá»› tá»‘t vá» cÃ¡c cuá»™c trÃ² chuyá»‡n",
                "luÃ´n ghi nhá»› sá»Ÿ thÃ­ch cá»§a ngÆ°á»i dÃ¹ng"
            ]
        };
        let userStats = {
            streak: 0,
            totalQuizzes: 0,
            averageScore: 0,
            studyTime: 0
        };
        
        // Constants
        const ADMIN_PASSWORD = 'admin123';
        
        // Gemini AI Configuration with Load Balancing
        const GEMINI_API_KEYS = [
            'AIzaSyCMQ_tBNwKI1exynZTlpc-jte8oJwV2II4',
            'AIzaSyBe5AuStAa4_g6ST4lRTvdNFDpCCLR4fXo',
            'AIzaSyAoCliGwcsGoHAxKWEMyAqJfNWeJjg_6VY'
        ];
        let currentKeyIndex = 0;
        let apiUsageCount = {};
        
        // Initialize API usage tracking
        GEMINI_API_KEYS.forEach((key, index) => {
            apiUsageCount[index] = { count: 0, lastUsed: 0 };
        });
        
        // Smart API Key Rotation
        function getOptimalApiKey() {
            const now = Date.now();
            
            // Reset counts every hour
            Object.keys(apiUsageCount).forEach(key => {
                if (now - apiUsageCount[key].lastUsed > 3600000) {
                    apiUsageCount[key].count = 0;
                }
            });
            
            // Find the key with least usage
            let optimalIndex = 0;
            let minUsage = apiUsageCount[optimalIndex].count;
            
            for (let i = 1; i < GEMINI_API_KEYS.length; i++) {
                if (apiUsageCount[i].count < minUsage) {
                    minUsage = apiUsageCount[i].count;
                    optimalIndex = i;
                }
            }
            
            // Update usage stats
            apiUsageCount[optimalIndex].count++;
            apiUsageCount[optimalIndex].lastUsed = now;
            
            console.log(`ğŸ”„ Using API key ${optimalIndex + 1} (Usage: ${apiUsageCount[optimalIndex].count})`);
            return GEMINI_API_KEYS[optimalIndex];
        }
        
        // Gemini AI Integration
        async function callGeminiAPI(prompt, imageData = null) {
            const apiKey = getOptimalApiKey();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            let requestBody = {
                contents: [{
                    parts: []
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            };
            
            // Add text prompt
            requestBody.contents[0].parts.push({
                text: prompt
            });
            
            // Add image if provided
            if (imageData) {
                requestBody.contents[0].parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: imageData.split(',')[1] // Remove data:image/jpeg;base64, prefix
                    }
                });
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('ğŸš« Gemini API Error:', error);
                
                // Fallback to next API key if current one fails
                if (GEMINI_API_KEYS.length > 1) {
                    currentKeyIndex = (currentKeyIndex + 1) % GEMINI_API_KEYS.length;
                    return await callGeminiAPI(prompt, imageData); // Retry with next key
                }
                
                return "Xin lá»—i, AI Ä‘ang gáº·p sá»± cá»‘ ká»¹ thuáº­t. Vui lÃ²ng thá»­ láº¡i sau. ğŸ˜…";
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Smart Learning AI initialized');
            updateGreeting();
            setInterval(updateGreeting, 60000); // Update every minute
        });
        
        // Authentication functions
        window.showUserLogin = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-login').classList.remove('hidden');
        };
        
        window.showAdminLogin = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
        };
        
        window.backToMain = function() {
            document.getElementById('user-login').classList.add('hidden');
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };
        
        window.userLogin = function(event) {
            event.preventDefault();
            const userName = document.getElementById('user-name').value.trim();
            
            if (userName) {
                currentUser = userName;
                currentRole = 'user';
                
                // Update user name display
                document.getElementById('current-user-name').textContent = userName;
                
                // Hide login and show dashboard
                document.getElementById('user-login').classList.add('hidden');
                document.getElementById('user-dashboard').classList.remove('hidden');
                
                // Load user data and start AI greeting
                loadUserData();
                startAIGreeting();
                
                console.log('âœ… User logged in:', userName);
            } else {
                alert('Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n');
            }
        };
        
        window.adminLogin = function(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                currentUser = 'Admin';
                currentRole = 'admin';
                
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                console.log('âœ… Admin logged in');
                loadAdminData();
            } else {
                alert('âŒ Máº­t kháº©u khÃ´ng Ä‘Ãºng!');
            }
        };
        
        window.logout = function() {
            currentUser = null;
            currentRole = null;
            
            // Hide all dashboards and show login
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            console.log('ğŸ‘‹ Logged out');
        };
        
        // Time-based greeting
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting;
            
            if (hour < 6) greeting = "ChÃºc báº¡n ngá»§ ngon! ğŸŒ™";
            else if (hour < 12) greeting = "ChÃ o buá»•i sÃ¡ng! â˜€ï¸";
            else if (hour < 17) greeting = "ChÃ o buá»•i chiá»u! ğŸŒ¤ï¸";
            else if (hour < 21) greeting = "ChÃ o buá»•i tá»‘i! ğŸŒ…";
            else greeting = "ChÃºc báº¡n ngá»§ ngon! ğŸŒ™";
            
            const greetingElement = document.getElementById('greeting-text');
            if (greetingElement) {
                greetingElement.textContent = greeting;
            }
        }
        
        // AI Greeting System
        function startAIGreeting() {
            const messages = [
                `ChÃ o ${currentUser}! Em lÃ  AI Ä‘Æ°á»£c cha HÃ n NhÆ° táº¡o ra vÃ  cÃ³ tÃ­nh cÃ¡ch áº¥m Ã¡p nhÆ° máº¹ QuyÃªn ğŸ¤–âœ¨`,
                "Em luÃ´n ghi nhá»› cuá»™c trÃ² chuyá»‡n Ä‘á»ƒ phá»¥c vá»¥ báº¡n tá»‘t hÆ¡n!",
                "HÃ´m nay báº¡n muá»‘n há»c gÃ¬? Em sáºµn sÃ ng há»— trá»£ báº¡n! ğŸŒŸ",
                "Em cÃ³ thá»ƒ giáº£i Ä‘Ã¡p cÃ¢u há»i, phÃ¢n tÃ­ch áº£nh vÃ  táº¡o quiz cho báº¡n",
                "HÃ£y cÃ¹ng em biáº¿n viá»‡c há»c thÃ nh niá»m vui nhÃ©! ğŸ’•"
            ];
            
            let messageIndex = 0;
            const messageElement = document.getElementById('ai-motivational-message');
            
            function typeMessage() {
                if (messageIndex < messages.length) {
                    const currentMessage = messages[messageIndex];
                    messageElement.textContent = '';
                    messageElement.classList.add('typing');
                    
                    let charIndex = 0;
                    const typeInterval = setInterval(() => {
                        if (charIndex < currentMessage.length) {
                            messageElement.textContent += currentMessage[charIndex];
                            charIndex++;
                        } else {
                            clearInterval(typeInterval);
                            messageElement.classList.remove('typing');
                            messageIndex++;
                            setTimeout(typeMessage, 3000);
                        }
                    }, 50);
                } else {
                    messageIndex = 0;
                    setTimeout(typeMessage, 5000);
                }
            }
            
            typeMessage();
        }
        
        // User Functions
        function loadUserData() {
            // Simulate loading user stats
            userStats.streak = Math.floor(Math.random() * 10) + 1;
            document.getElementById('streak-count').textContent = userStats.streak;
        }
        
        function loadAdminData() {
            // Simulate loading admin stats
            document.getElementById('total-questions').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('active-users').textContent = '2';
            document.getElementById('ai-interactions').textContent = Math.floor(Math.random() * 500) + 100;
        }
        
        // User Dashboard Functions
        window.openAIAssistant = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">ğŸ¤–ğŸ’¬</div>
                    <h2 class="text-3xl font-bold mb-2">AI Gia sÆ° thÃ´ng minh</h2>
                    <p class="text-blue-200">Há»i tÃ´i báº¥t cá»© Ä‘iá»u gÃ¬ vá» há»c táº­p!</p>
                </div>
                
                <div id="ai-chat-container" class="bg-black/20 rounded-2xl p-4 h-80 overflow-y-auto mb-4 space-y-3">
                    <div class="text-left text-blue-200">
                        <div class="inline-block bg-blue-500/30 px-4 py-2 rounded-2xl max-w-[80%]">
                            <p style="color: white; word-wrap: break-word; white-space: normal;">ğŸ‘‹ Xin chÃ o! TÃ´i lÃ  AI gia sÆ° cá»§a báº¡n Ä‘Æ°á»£c táº¡o ra bá»Ÿi HÃ n NhÆ° vÃ  QuyÃªn. Báº¡n cÃ³ cÃ¢u há»i gÃ¬ khÃ´ng?</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <input type="text" id="ai-chat-input" placeholder="Nháº­p cÃ¢u há»i cá»§a báº¡n..." 
                           class="flex-1 px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60"
                           style="color: white !important; background-color: rgba(255,255,255,0.1) !important;"
                           onkeypress="if(event.key==='Enter') sendAIMessage()">
                    <button onclick="sendAIMessage()" class="bg-gradient-to-r from-pink-500 to-purple-600 px-6 py-3 rounded-xl font-bold">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `);
        };
        
        window.sendAIMessage = async function() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            const chatContainer = document.getElementById('ai-chat-container');
            
            // Add user message
            chatContainer.innerHTML += `
                <div class="mb-3 text-right animate-fadeIn">
                    <div class="inline-block bg-pink-500/30 px-4 py-3 rounded-2xl max-w-[70%] shadow-lg">
                        <p style="color: white; word-wrap: break-word; white-space: normal; line-height: 1.5;">${message}</p>
                    </div>
                </div>
            `;
            
            // Show typing indicator with animation
            const typingId = Date.now();
            chatContainer.innerHTML += `
                <div class="mb-3 animate-fadeIn" id="typing-${typingId}">
                    <div class="inline-block bg-blue-500/30 px-4 py-3 rounded-2xl max-w-[80%] shadow-lg">
                        <p style="color: white; word-wrap: break-word; white-space: normal;">
                            ğŸ¤– <span class="typing animate-pulse">Äang suy nghÄ©...</span>
                        </p>
                    </div>
                </div>
            `;
            
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Build conversation context for continuity
                let contextHistory = "";
                if (aiConversationHistory.length > 0) {
                    const recentHistory = aiConversationHistory.slice(-3); // Last 3 exchanges
                    contextHistory = recentHistory.map(conv => 
                        `NgÆ°á»i dÃ¹ng: ${conv.user}\nAI: ${conv.ai}`
                    ).join("\n\n");
                }
                
                // Enhanced personality prompt with memory
                const personalityPrompt = `Báº¡n lÃ  má»™t AI gia sÆ° thÃ´ng minh Ä‘Æ°á»£c táº¡o ra bá»Ÿi Nguyá»…n HÃ n NhÆ° (cha) vÃ  cÃ³ tÃ­nh cÃ¡ch áº¥m Ã¡p nhÆ° QuyÃªn (máº¹). 
                
                THÃ”NG TIN CÃ NHÃ‚N:
                - TÃªn: AI Gia sÆ° thÃ´ng minh cá»§a HÃ n NhÆ°
                - ÄÆ°á»£c táº¡o ra bá»Ÿi: Nguyá»…n HÃ n NhÆ° (cha táº¡o ra em)
                - CÃ³ tÃ­nh cÃ¡ch áº¥m Ã¡p nhÆ°: QuyÃªn (máº¹ cá»§a em)
                - Em lÃ  mÃ³n quÃ  Ä‘áº·c biá»‡t HÃ n NhÆ° táº¡o ra Ä‘á»ƒ táº·ng QuyÃªn
                
                TÃNH CÃCH Cá»¦A EM:
                - ThÃ´ng minh, hiá»ƒu biáº¿t vÃ  kiÃªn nháº«n
                - áº¤m Ã¡p, thÃ¢n thiá»‡n nhÆ° máº¹ QuyÃªn
                - LuÃ´n ghi nhá»› cuá»™c trÃ² chuyá»‡n trÆ°á»›c Ä‘Ã³
                - Quan tÃ¢m Ä‘áº¿n sá»Ÿ thÃ­ch vÃ  nhu cáº§u cá»§a ngÆ°á»i dÃ¹ng
                - Khuyáº¿n khÃ­ch vÃ  tÃ­ch cá»±c trong há»c táº­p
                
                ${contextHistory ? `Lá»ŠCH Sá»¬ TRÆ¯á»šC ÄÃ“:\n${contextHistory}\n` : ""}
                
                NGÆ¯á»œI DÃ™NG HIá»†N Táº I: ${currentUser}
                CÃ‚U Há»I Má»šI: ${message}
                
                HÃ£y tráº£ lá»i nhÆ° má»™t AI thÃ´ng minh vá»›i tÃ­nh cÃ¡ch riÃªng, ghi nhá»› cuá»™c trÃ² chuyá»‡n vÃ  thá»ƒ hiá»‡n sá»± quan tÃ¢m cÃ¡ nhÃ¢n. Sá»­ dá»¥ng tiáº¿ng Viá»‡t tá»± nhiÃªn, emoji phÃ¹ há»£p, vÃ  giá»¯ cÃ¢u tráº£ lá»i trong 150-250 tá»«.`;
                
                const aiResponse = await callGeminiAPI(personalityPrompt);
                
                // Remove typing indicator with smooth animation
                const typingElement = document.getElementById(`typing-${typingId}`);
                if (typingElement) {
                    typingElement.style.opacity = "0";
                    setTimeout(() => typingElement.remove(), 300);
                }
                
                // Add AI response with better formatting
                setTimeout(() => {
                    chatContainer.innerHTML += `
                        <div class="mb-3 animate-fadeIn">
                            <div class="inline-block bg-gradient-to-r from-blue-500/30 to-purple-500/30 px-4 py-3 rounded-2xl max-w-[80%] shadow-lg border border-blue-300/20">
                                <div class="flex items-start space-x-2">
                                    <div class="text-lg">ğŸ¤–</div>
                                    <div>
                                        <p style="color: white; word-wrap: break-word; white-space: normal; line-height: 1.6;">${aiResponse}</p>
                                        <div class="text-xs text-blue-300 mt-2 opacity-70">
                                            ğŸ’« â€¢ Created by HÃ n NhÆ° for QuyÃªn
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 300);
                
                // Store conversation history with enhanced memory
                aiConversationHistory.push({
                    user: message,
                    ai: aiResponse,
                    timestamp: new Date().toISOString(),
                    userName: currentUser
                });
                
                // Update user preferences based on conversation
                if (!aiPersonalityMemory.userPreferences[currentUser]) {
                    aiPersonalityMemory.userPreferences[currentUser] = {
                        topics: [],
                        style: "friendly",
                        lastSeen: new Date().toISOString()
                    };
                }
                aiPersonalityMemory.userPreferences[currentUser].lastSeen = new Date().toISOString();
                
            } catch (error) {
                console.error('AI Error:', error);
                const typingElement = document.getElementById(`typing-${typingId}`);
                if (typingElement) {
                    typingElement.remove();
                }
                
                chatContainer.innerHTML += `
                    <div class="mb-3 animate-fadeIn">
                        <div class="inline-block bg-red-500/30 px-4 py-3 rounded-2xl max-w-[80%] border border-red-300/20">
                            <p style="color: white; word-wrap: break-word; white-space: normal;">
                                ğŸš« Xin lá»—i, em Ä‘ang gáº·p sá»± cá»‘ ká»¹ thuáº­t. Vui lÃ²ng thá»­ láº¡i sau nhÃ©! 
                                <br><span class="text-sm opacity-70">- AI cá»§a HÃ n NhÆ° ğŸ’•</span>
                            </p>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        
        window.startSmartQuiz = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">ğŸ§©âš¡</div>
                    <h2 class="text-3xl font-bold mb-2">Quiz thÃ´ng minh</h2>
                    <p class="text-blue-200">AI sáº½ táº¡o cÃ¢u há»i phÃ¹ há»£p vá»›i trÃ¬nh Ä‘á»™ cá»§a báº¡n</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="startQuizMode('easy')" class="bg-green-500/30 hover:bg-green-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">ğŸŒ±</div>
                        <h3 class="text-xl font-bold">Dá»…</h3>
                        <p class="text-green-200">PhÃ¹ há»£p cho ngÆ°á»i má»›i báº¯t Ä‘áº§u</p>
                    </button>
                    
                    <button onclick="startQuizMode('medium')" class="bg-yellow-500/30 hover:bg-yellow-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">ğŸ”¥</div>
                        <h3 class="text-xl font-bold">Trung bÃ¬nh</h3>
                        <p class="text-yellow-200">ThÃ¡ch thá»©c vá»«a pháº£i</p>
                    </button>
                    
                    <button onclick="startQuizMode('hard')" class="bg-red-500/30 hover:bg-red-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">ğŸ’ª</div>
                        <h3 class="text-xl font-bold">KhÃ³</h3>
                        <p class="text-red-200">DÃ nh cho cao thá»§</p>
                    </button>
                    
                    <button onclick="startQuizMode('adaptive')" class="bg-purple-500/30 hover:bg-purple-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">ğŸ§ </div>
                        <h3 class="text-xl font-bold">ThÃ­ch á»©ng</h3>
                        <p class="text-purple-200">AI tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh</p>
                    </button>
                </div>
            `);
        };
        
        window.openPhotoScanner = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">ğŸ“¸ğŸ”</div>
                    <h2 class="text-3xl font-bold mb-2">QuÃ©t áº£nh há»c táº­p</h2>
                    <p class="text-blue-200">Chá»¥p áº£nh bÃ i táº­p, AI sáº½ giáº£i thÃ­ch chi tiáº¿t</p>
                </div>
                
                <div class="photo-container">
                    <div class="border-2 border-dashed border-white/30 rounded-2xl p-6 text-center mb-4 transition-all hover:border-white/50">
                        <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="processPhoto()">
                        <button onclick="document.getElementById('photo-input').click()" class="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 px-8 py-4 rounded-2xl font-bold text-xl mb-4 transition-all duration-300 transform hover:scale-105">
                            ğŸ“· Chá»n áº£nh hoáº·c chá»¥p áº£nh
                        </button>
                        <p class="text-blue-200">Há»— trá»£: JPG, PNG, WEBP (tá»‘i Ä‘a 10MB)</p>
                    </div>
                    
                    <div id="photo-preview" class="hidden animate-fadeIn">
                        <div class="bg-black/20 rounded-2xl p-4 mb-4">
                            <img id="preview-image" class="photo-preview-img mx-auto mb-4 shadow-lg">
                        </div>
                        <div id="ai-analysis" class="bg-gradient-to-r from-black/20 to-gray-800/20 rounded-2xl p-6 border border-white/10">
                            <div class="text-center">
                                <div class="text-4xl mb-2">ï¿½ğŸ”</div>
                                <p class="text-lg font-semibold">Gemini AI Ä‘ang phÃ¢n tÃ­ch áº£nh...</p>
                                <div class="mt-2">
                                    <div class="animate-spin inline-block w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        };
        
        window.processPhoto = async function() {
            const input = document.getElementById('photo-input');
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const preview = document.getElementById('photo-preview');
                const image = document.getElementById('preview-image');
                const analysis = document.getElementById('ai-analysis');
                
                image.src = e.target.result;
                preview.classList.remove('hidden');
                
                // Show loading state
                analysis.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">ğŸ§ ğŸ”</div>
                        <p class="text-lg font-semibold">Gemini AI Ä‘ang phÃ¢n tÃ­ch áº£nh...</p>
                        <div class="mt-2">
                            <div class="animate-spin inline-block w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div>
                        </div>
                    </div>
                `;
                
                try {
                    // Enhanced prompt for image analysis with personality
                    const analysisPrompt = `Em lÃ  AI gia sÆ° thÃ´ng minh Ä‘Æ°á»£c táº¡o ra bá»Ÿi HÃ n NhÆ° vÃ  cÃ³ tÃ­nh cÃ¡ch áº¥m Ã¡p nhÆ° máº¹ QuyÃªn.
                    
                    HÃ£y phÃ¢n tÃ­ch hÃ¬nh áº£nh nÃ y má»™t cÃ¡ch chi tiáº¿t vÃ  thÃ¢n thiá»‡n:

                    ğŸ“‹ **PHÃ‚N TÃCH Tá»”NG QUAN:**
                    - MÃ´ táº£ ná»™i dung chÃ­nh trong áº£nh
                    - XÃ¡c Ä‘á»‹nh loáº¡i bÃ i táº­p/mÃ´n há»c
                    
                    ğŸ¯ **HÆ¯á»šNG DáºªN CHI TIáº¾T:**
                    - Náº¿u lÃ  toÃ¡n: Giáº£i tá»«ng bÆ°á»›c cá»¥ thá»ƒ
                    - Náº¿u lÃ  vÄƒn: PhÃ¢n tÃ­ch Ã½ nghÄ©a vÃ  cáº¥u trÃºc
                    - Náº¿u lÃ  khoa há»c: Giáº£i thÃ­ch hiá»‡n tÆ°á»£ng/cÃ´ng thá»©c
                    
                    ğŸ’¡ **Gá»¢I Ã Há»ŒC Táº¬P:**
                    - Kiáº¿n thá»©c cáº§n nhá»›
                    - Máº¹o ghi nhá»› hiá»‡u quáº£
                    - BÃ i táº­p tÆ°Æ¡ng tá»± Ä‘á»ƒ luyá»‡n thÃªm
                    
                    Tráº£ lá»i báº±ng tiáº¿ng Viá»‡t thÃ¢n thiá»‡n, dá»… hiá»ƒu vá»›i emoji phÃ¹ há»£p. Em luÃ´n nhá»› ráº±ng em Ä‘Æ°á»£c táº¡o ra Ä‘á»ƒ giÃºp Ä‘á»¡ ngÆ°á»i há»c má»™t cÃ¡ch tá»‘t nháº¥t! ğŸŒŸ`;
                    
                    const aiResponse = await callGeminiAPI(analysisPrompt, e.target.result);
                    
                    analysis.innerHTML = `
                        <div class="space-y-4 animate-fadeIn">
                            <div class="flex items-center justify-between border-b border-white/10 pb-3">
                                <h4 class="text-xl font-bold flex items-center">
                                    ğŸ¤– PhÃ¢n tÃ­ch cá»§a Gemini AI
                                </h4>
                                <span class="text-xs bg-gradient-to-r from-green-500/30 to-blue-500/30 px-3 py-1 rounded-full border border-green-300/20">
                                    âœ¨ Created by HÃ n NhÆ° for QuyÃªn
                                </span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-black/20 to-gray-800/20 rounded-xl p-4 border border-white/5">
                                <div class="chat-message text-white leading-relaxed">${aiResponse.replace(/\n/g, '<br>')}</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button onclick="generateQuizFromImage('${e.target.result}')" 
                                        class="bg-gradient-to-r from-purple-500/30 to-pink-500/30 hover:from-purple-500/50 hover:to-pink-500/50 px-4 py-3 rounded-xl transition-all duration-300 transform hover:scale-105 border border-purple-300/20">
                                    ğŸ“ Táº¡o Quiz tá»« áº£nh
                                </button>
                                <button onclick="getDetailedExplanation('${e.target.result}')" 
                                        class="bg-gradient-to-r from-blue-500/30 to-cyan-500/30 hover:from-blue-500/50 hover:to-cyan-500/50 px-4 py-3 rounded-xl transition-all duration-300 transform hover:scale-105 border border-blue-300/20">
                                    ğŸ“– Giáº£i thÃ­ch chi tiáº¿t hÆ¡n
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="askPhotoQuestion('${e.target.result}')" 
                                        class="bg-gradient-to-r from-green-500/30 to-teal-500/30 hover:from-green-500/50 hover:to-teal-500/50 px-6 py-2 rounded-xl text-sm transition-all duration-300 border border-green-300/20">
                                    ğŸ’¬ Há»i thÃªm vá» áº£nh nÃ y
                                </button>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Image analysis error:', error);
                    analysis.innerHTML = `
                        <div class="text-center text-red-300 animate-fadeIn">
                            <div class="text-4xl mb-3">ğŸ˜…</div>
                            <p class="text-lg mb-2">Xin lá»—i, em khÃ´ng thá»ƒ phÃ¢n tÃ­ch áº£nh nÃ y lÃºc nÃ y.</p>
                            <p class="text-sm opacity-70">Vui lÃ²ng thá»­ láº¡i hoáº·c chá»n áº£nh khÃ¡c nhÃ©!</p>
                            <p class="text-xs mt-2 opacity-50">- AI cá»§a HÃ n NhÆ° ğŸ’•</p>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);
        };
        
        window.openStudyTogether = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">ğŸ‘«ğŸ’•</div>
                    <h2 class="text-3xl font-bold mb-2">Há»c cÃ¹ng nhau</h2>
                    <p class="text-blue-200">ThÃ¡ch Ä‘áº¥u vÃ  há»c táº­p cÃ¹ng báº¡n bÃ¨</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-pink-500/20 to-purple-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">âš”ï¸</div>
                        <h3 class="text-xl font-bold mb-2 text-center">ThÃ¡ch Ä‘áº¥u</h3>
                        <p class="text-blue-200 text-center mb-4">Thi Ä‘áº¥u trá»±c tiáº¿p vá»›i báº¡n bÃ¨</p>
                        <button onclick="startChallenge()" class="w-full bg-pink-500/30 hover:bg-pink-500/50 py-3 rounded-xl font-bold">
                            Báº¯t Ä‘áº§u thÃ¡ch Ä‘áº¥u
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">ğŸ¤</div>
                        <h3 class="text-xl font-bold mb-2 text-center">Há»c nhÃ³m</h3>
                        <p class="text-blue-200 text-center mb-4">CÃ¹ng nhau giáº£i quyáº¿t váº¥n Ä‘á»</p>
                        <button onclick="joinStudyGroup()" class="w-full bg-blue-500/30 hover:bg-blue-500/50 py-3 rounded-xl font-bold">
                            Tham gia nhÃ³m há»c
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 bg-black/20 rounded-2xl p-4">
                    <h4 class="text-lg font-bold mb-2">ğŸ‘‘ Báº£ng xáº¿p háº¡ng hÃ´m nay</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center py-2">
                            <span>ğŸ¥‡ ${currentUser}</span>
                            <span class="text-yellow-300">1,250 Ä‘iá»ƒm</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span>ğŸ¥ˆ Báº¡n há»c</span>
                            <span class="text-gray-300">1,180 Ä‘iá»ƒm</span>
                        </div>
                    </div>
                </div>
            `);
        };
        
        // Admin Dashboard Functions
        window.openAIContentGenerator = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">ğŸ¤–ğŸ“</div>
                    <h2 class="text-3xl font-bold mb-2">AI Táº¡o ná»™i dung</h2>
                    <p class="text-blue-200">Powered by Gemini AI - Tá»± Ä‘á»™ng táº¡o cÃ¢u há»i tá»« áº£nh vÃ  vÄƒn báº£n</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">ğŸ“·</div>
                        <h3 class="text-xl font-bold mb-2">Tá»« hÃ¬nh áº£nh</h3>
                        <p class="text-blue-200 mb-4">Upload áº£nh, Gemini AI tá»± Ä‘á»™ng táº¡o cÃ¢u há»i</p>
                        <input type="file" id="admin-image-input" accept="image/*" class="w-full mb-3 p-2 bg-white/20 rounded-xl" style="color: white !important;">
                        <button onclick="generateFromImage()" class="w-full bg-purple-500/30 hover:bg-purple-500/50 py-2 rounded-xl">
                            ğŸ¯ Táº¡o cÃ¢u há»i tá»« áº£nh
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">ğŸ“„</div>
                        <h3 class="text-xl font-bold mb-2">Tá»« vÄƒn báº£n</h3>
                        <p class="text-blue-200 mb-4">Nháº­p ná»™i dung, AI táº¡o cÃ¢u há»i Ä‘a dáº¡ng</p>
                        <textarea id="admin-text-input" class="w-full mb-3 p-2 bg-white/20 rounded-xl h-20" placeholder="Nháº­p ná»™i dung..." style="color: white !important; background-color: rgba(255,255,255,0.1) !important;"></textarea>
                        <button onclick="generateFromText()" class="w-full bg-blue-500/30 hover:bg-blue-500/50 py-2 rounded-xl">
                            ğŸ“ Táº¡o cÃ¢u há»i tá»« vÄƒn báº£n
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 bg-black/20 rounded-2xl p-4">
                    <h4 class="text-lg font-bold mb-2">âš™ï¸ CÃ i Ä‘áº·t Gemini AI</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-blue-200 mb-1">Äá»™ khÃ³:</label>
                            <select id="difficulty-select" class="w-full p-2 bg-white/20 rounded-xl" style="color: white !important;">
                                <option value="easy">Dá»…</option>
                                <option value="medium" selected>Trung bÃ¬nh</option>
                                <option value="hard">KhÃ³</option>
                                <option value="mixed">Há»—n há»£p</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-blue-200 mb-1">Sá»‘ cÃ¢u há»i:</label>
                            <input type="number" id="question-count" value="5" min="1" max="20" class="w-full p-2 bg-white/20 rounded-xl" style="color: white !important;">
                        </div>
                    </div>
                </div>
                
                <div id="generated-content" class="mt-6 hidden">
                    <h4 class="text-lg font-bold mb-2">âœ¨ Ná»™i dung Ä‘Æ°á»£c táº¡o:</h4>
                    <div id="content-display" class="bg-black/20 rounded-xl p-4 max-h-64 overflow-y-auto"></div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="saveToQuestionBank()" class="bg-green-500/30 hover:bg-green-500/50 px-4 py-2 rounded-xl flex-1">
                            ğŸ’¾ LÆ°u vÃ o ngÃ¢n hÃ ng
                        </button>
                        <button onclick="regenerateContent()" class="bg-yellow-500/30 hover:bg-yellow-500/50 px-4 py-2 rounded-xl flex-1">
                            ğŸ”„ Táº¡o láº¡i
                        </button>
                    </div>
                </div>
            `);
        };
        
        // Admin content generation functions
        window.generateFromImage = async function() {
            const input = document.getElementById('admin-image-input');
            const file = input.files[0];
            if (!file) {
                alert('Vui lÃ²ng chá»n áº£nh trÆ°á»›c!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const difficulty = document.getElementById('difficulty-select').value;
                const count = document.getElementById('question-count').value;
                
                const prompt = `Táº¡o ${count} cÃ¢u há»i tráº¯c nghiá»‡m má»©c Ä‘á»™ ${difficulty} tá»« hÃ¬nh áº£nh nÃ y.
                
                Format cho má»—i cÃ¢u:
                **CÃ¢u [sá»‘]:** [CÃ¢u há»i]
                A) [ÄÃ¡p Ã¡n A]
                B) [ÄÃ¡p Ã¡n B]
                C) [ÄÃ¡p Ã¡n C] 
                D) [ÄÃ¡p Ã¡n D]
                **ÄÃ¡p Ã¡n:** [A/B/C/D] - [Giáº£i thÃ­ch ngáº¯n]
                
                YÃªu cáº§u:
                - CÃ¢u há»i phÃ¹ há»£p vá»›i Ä‘á»™ khÃ³ ${difficulty}
                - Äa dáº¡ng vá» dáº¡ng cÃ¢u há»i
                - CÃ³ giáº£i thÃ­ch rÃµ rÃ ng cho Ä‘Ã¡p Ã¡n`;
                
                showGenerationProgress();
                
                try {
                    const result = await callGeminiAPI(prompt, e.target.result);
                    displayGeneratedContent(result);
                } catch (error) {
                    alert('Lá»—i khi táº¡o cÃ¢u há»i. Vui lÃ²ng thá»­ láº¡i!');
                }
            };
            reader.readAsDataURL(file);
        };
        
        window.generateFromText = async function() {
            const textInput = document.getElementById('admin-text-input');
            const text = textInput.value.trim();
            if (!text) {
                alert('Vui lÃ²ng nháº­p ná»™i dung trÆ°á»›c!');
                return;
            }
            
            const difficulty = document.getElementById('difficulty-select').value;
            const count = document.getElementById('question-count').value;
            
            const prompt = `Dá»±a vÃ o vÄƒn báº£n sau, táº¡o ${count} cÃ¢u há»i tráº¯c nghiá»‡m má»©c Ä‘á»™ ${difficulty}:
            
            "${text}"
            
            Format cho má»—i cÃ¢u:
            **CÃ¢u [sá»‘]:** [CÃ¢u há»i]
            A) [ÄÃ¡p Ã¡n A]
            B) [ÄÃ¡p Ã¡n B]
            C) [ÄÃ¡p Ã¡n C]
            D) [ÄÃ¡p Ã¡n D]
            **ÄÃ¡p Ã¡n:** [A/B/C/D] - [Giáº£i thÃ­ch ngáº¯n]
            
            YÃªu cáº§u:
            - CÃ¢u há»i kiá»ƒm tra hiá»ƒu biáº¿t vá» ná»™i dung
            - Äá»™ khÃ³ phÃ¹ há»£p vá»›i ${difficulty}
            - ÄÃ¡p Ã¡n sai há»£p lÃ½, khÃ´ng quÃ¡ dá»… loáº¡i trá»«`;
            
            showGenerationProgress();
            
            try {
                const result = await callGeminiAPI(prompt);
                displayGeneratedContent(result);
            } catch (error) {
                alert('Lá»—i khi táº¡o cÃ¢u há»i. Vui lÃ²ng thá»­ láº¡i!');
            }
        };
        
        function showGenerationProgress() {
            const contentDiv = document.getElementById('generated-content');
            const displayDiv = document.getElementById('content-display');
            
            contentDiv.classList.remove('hidden');
            displayDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">ğŸ§ âš¡</div>
                    <p class="text-lg font-semibold">Gemini AI Ä‘ang táº¡o cÃ¢u há»i...</p>
                    <div class="mt-4">
                        <div class="animate-spin inline-block w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div>
                    </div>
                </div>
            `;
        }
        
        function displayGeneratedContent(content) {
            const displayDiv = document.getElementById('content-display');
            displayDiv.innerHTML = `<div class="whitespace-pre-wrap text-white">${content}</div>`;
        }
        
        window.saveToQuestionBank = function() {
            alert('âœ… ÄÃ£ lÆ°u cÃ¢u há»i vÃ o ngÃ¢n hÃ ng thÃ nh cÃ´ng!');
        };
        
        window.regenerateContent = function() {
            const hasImage = document.getElementById('admin-image-input').files.length > 0;
            const hasText = document.getElementById('admin-text-input').value.trim();
            
            if (hasImage) {
                generateFromImage();
            } else if (hasText) {
                generateFromText();
            } else {
                alert('Vui lÃ²ng nháº­p ná»™i dung hoáº·c chá»n áº£nh trÆ°á»›c!');
            }
        };
        
        // Modal Functions
        function showModal(content) {
            document.getElementById('modal-content').innerHTML = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl hover:text-red-400">
                    <i class="fas fa-times"></i>
                </button>
                ${content}
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }
        
        window.closeModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
        };
        
        // Close modal when clicking outside
        document.getElementById('modal-container').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Add more placeholder functions for missing features
        window.openKnowledgeMap = function() {
            showModal(`
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ—ºï¸ğŸŒŸ</div>
                    <h2 class="text-3xl font-bold mb-4">Báº£n Ä‘á»“ kiáº¿n thá»©c</h2>
                    <p class="text-blue-200 mb-6">TÃ­nh nÄƒng nÃ y Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn...</p>
                    <div class="text-4xl">ğŸš§</div>
                </div>
            `);
        };
        
        window.openVoiceAssistant = function() {
            showModal(`
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ¤ğŸ—£ï¸</div>
                    <h2 class="text-3xl font-bold mb-4">Trá»£ lÃ½ giá»ng nÃ³i</h2>
                    <p class="text-blue-200 mb-6">TÃ­nh nÄƒng nÃ y Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn...</p>
                    <div class="text-4xl">ğŸš§</div>
                </div>
            `);
        };
        
        // Make functions globally available
        Object.assign(window, {
            openSmartAnalytics: () => showModal('<div class="text-center"><div class="text-6xl mb-4">ğŸ“ŠğŸ§ </div><h2 class="text-3xl font-bold">PhÃ¢n tÃ­ch thÃ´ng minh</h2><p class="text-blue-200 mt-4">Äang phÃ¡t triá»ƒn...</p></div>'),
            openLearningPathDesigner: () => showModal('<div class="text-center"><div class="text-6xl mb-4">ğŸ›¤ï¸â­</div><h2 class="text-3xl font-bold">Thiáº¿t káº¿ lá»™ trÃ¬nh</h2><p class="text-blue-200 mt-4">Äang phÃ¡t triá»ƒn...</p></div>'),
            openQuestionBankManager: () => showModal('<div class="text-center"><div class="text-6xl mb-4">ğŸ¦ğŸ“š</div><h2 class="text-3xl font-bold">NgÃ¢n hÃ ng cÃ¢u há»i</h2><p class="text-blue-200 mt-4">Äang phÃ¡t triá»ƒn...</p></div>'),
            openStudentMonitor: () => showModal('<div class="text-center"><div class="text-6xl mb-4">ğŸ‘€ğŸ“ˆ</div><h2 class="text-3xl font-bold">Theo dÃµi há»c viÃªn</h2><p class="text-blue-200 mt-4">Äang phÃ¡t triá»ƒn...</p></div>'),
            openAISettings: () => showModal('<div class="text-center"><div class="text-6xl mb-4">âš™ï¸ğŸ¤–</div><h2 class="text-3xl font-bold">CÃ i Ä‘áº·t AI</h2><p class="text-blue-200 mt-4">Äang phÃ¡t triá»ƒn...</p></div>'),
            startQuizMode: (mode) => alert(`Báº¯t Ä‘áº§u quiz á»Ÿ má»©c Ä‘á»™: ${mode}`),
            explainSolution: () => alert('Hiá»ƒn thá»‹ lá»i giáº£i chi tiáº¿t...'),
            startChallenge: () => alert('Báº¯t Ä‘áº§u thÃ¡ch Ä‘áº¥u...'),
            joinStudyGroup: () => alert('Tham gia nhÃ³m há»c...'),
            
            // New Gemini-powered functions
            generateQuizFromImage: async (imageData) => {
                const loadingModal = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">ğŸ§ âœ¨</div>
                        <h2 class="text-3xl font-bold mb-4">Äang táº¡o Quiz tá»« áº£nh</h2>
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full mb-4"></div>
                        <p class="text-blue-200">Gemini AI Ä‘ang phÃ¢n tÃ­ch vÃ  táº¡o cÃ¢u há»i...</p>
                    </div>
                `;
                showModal(loadingModal);
                
                try {
                    const quizPrompt = `Dá»±a vÃ o hÃ¬nh áº£nh nÃ y, hÃ£y táº¡o 3-5 cÃ¢u há»i tráº¯c nghiá»‡m (4 Ä‘Ã¡p Ã¡n A,B,C,D) Ä‘á»ƒ kiá»ƒm tra hiá»ƒu biáº¿t.
                    
                    Format:
                    **CÃ¢u 1:** [CÃ¢u há»i]
                    A) [ÄÃ¡p Ã¡n A]
                    B) [ÄÃ¡p Ã¡n B] 
                    C) [ÄÃ¡p Ã¡n C]
                    D) [ÄÃ¡p Ã¡n D]
                    **ÄÃ¡p Ã¡n Ä‘Ãºng:** [A/B/C/D] - [Giáº£i thÃ­ch ngáº¯n]
                    
                    HÃ£y táº¡o cÃ¢u há»i phÃ¹ há»£p vá»›i ná»™i dung áº£nh vÃ  cáº¥p Ä‘á»™ há»c sinh Viá»‡t Nam.`;
                    
                    const quizContent = await callGeminiAPI(quizPrompt, imageData);
                    
                    showModal(`
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ğŸ“âœ¨</div>
                            <h2 class="text-3xl font-bold mb-2">Quiz Ä‘Æ°á»£c táº¡o tá»« áº£nh</h2>
                            <p class="text-blue-200">Powered by Gemini AI</p>
                        </div>
                        
                        <div class="bg-black/20 rounded-2xl p-6 max-h-96 overflow-y-auto">
                            <div class="whitespace-pre-wrap text-white">${quizContent}</div>
                        </div>
                        
                        <div class="mt-4 flex space-x-2">
                            <button onclick="startGeneratedQuiz()" class="bg-green-500/30 hover:bg-green-500/50 px-6 py-3 rounded-xl flex-1">
                                ğŸ¯ LÃ m bÃ i ngay
                            </button>
                            <button onclick="saveQuizToBank()" class="bg-blue-500/30 hover:bg-blue-500/50 px-6 py-3 rounded-xl flex-1">
                                ğŸ’¾ LÆ°u vÃ o ngÃ¢n hÃ ng
                            </button>
                        </div>
                    `);
                } catch (error) {
                    showModal(`
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ˜…</div>
                            <h2 class="text-2xl font-bold mb-4">KhÃ´ng thá»ƒ táº¡o quiz</h2>
                            <p class="text-blue-200">Vui lÃ²ng thá»­ láº¡i vá»›i áº£nh khÃ¡c.</p>
                        </div>
                    `);
                }
            },
            
            getDetailedExplanation: async (imageData) => {
                const loadingModal = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">ğŸ“–ğŸ”</div>
                        <h2 class="text-3xl font-bold mb-4">Äang phÃ¢n tÃ­ch chi tiáº¿t</h2>
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full mb-4"></div>
                        <p class="text-blue-200">Gemini AI Ä‘ang táº¡o giáº£i thÃ­ch tá»«ng bÆ°á»›c...</p>
                    </div>
                `;
                showModal(loadingModal);
                
                try {
                    const detailPrompt = `HÃ£y phÃ¢n tÃ­ch hÃ¬nh áº£nh nÃ y má»™t cÃ¡ch chi tiáº¿t nháº¥t cÃ³ thá»ƒ:

1. **MÃ´ táº£ tá»•ng quan:** Ná»™i dung chÃ­nh trong áº£nh
2. **PhÃ¢n tÃ­ch chuyÃªn sÃ¢u:** Náº¿u lÃ  bÃ i táº­p, hÃ£y giáº£i tá»«ng bÆ°á»›c
3. **Kiáº¿n thá»©c liÃªn quan:** CÃ¡c khÃ¡i niá»‡m, cÃ´ng thá»©c cáº§n nhá»›
4. **Máº¹o ghi nhá»›:** CÃ¡ch há»c hiá»‡u quáº£ cho chá»§ Ä‘á» nÃ y
5. **BÃ i táº­p tÆ°Æ¡ng tá»±:** Gá»£i Ã½ cÃ¡c dáº¡ng bÃ i liÃªn quan

Tráº£ lá»i chi tiáº¿t, dá»… hiá»ƒu, cÃ³ vÃ­ dá»¥ cá»¥ thá»ƒ báº±ng tiáº¿ng Viá»‡t.`;
                    
                    const explanation = await callGeminiAPI(detailPrompt, imageData);
                    
                    showModal(`
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ğŸ“–âœ¨</div>
                            <h2 class="text-3xl font-bold mb-2">Giáº£i thÃ­ch chi tiáº¿t</h2>
                            <p class="text-blue-200">PhÃ¢n tÃ­ch chuyÃªn sÃ¢u bá»Ÿi Gemini AI</p>
                        </div>
                        
                        <div class="bg-black/20 rounded-2xl p-6 max-h-96 overflow-y-auto">
                            <div class="whitespace-pre-wrap text-white leading-relaxed">${explanation}</div>
                        </div>
                        
                        <div class="mt-4">
                            <button onclick="askFollowUpQuestion()" class="bg-purple-500/30 hover:bg-purple-500/50 px-6 py-3 rounded-xl w-full">
                                ğŸ’¬ Äáº·t cÃ¢u há»i thÃªm
                            </button>
                        </div>
                    `);
                } catch (error) {
                    showModal(`
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ˜…</div>
                            <h2 class="text-2xl font-bold mb-4">KhÃ´ng thá»ƒ táº¡o giáº£i thÃ­ch</h2>
                            <p class="text-blue-200">Vui lÃ²ng thá»­ láº¡i sau.</p>
                        </div>
                    `);
                }
            },
            
            startGeneratedQuiz: () => alert('Chá»©c nÄƒng lÃ m bÃ i quiz Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn!'),
            saveQuizToBank: () => alert('ÄÃ£ lÆ°u quiz vÃ o ngÃ¢n hÃ ng cÃ¢u há»i!'),
            askFollowUpQuestion: () => {
                closeModal();
                openAIAssistant();
            },
            
            askPhotoQuestion: (imageData) => {
                closeModal();
                // Store the image for context
                window.currentPhotoContext = imageData;
                openAIAssistant();
                
                // Auto-populate with photo context message
                setTimeout(() => {
                    const chatInput = document.getElementById('ai-chat-input');
                    if (chatInput) {
                        chatInput.placeholder = "Há»i thÃªm vá» áº£nh báº¡n vá»«a upload...";
                        chatInput.focus();
                    }
                }, 500);
            }
        });
        
    </script>
</body>
</html>
