<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💕 Smart Learning AI - Hệ thống học tập thông minh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCGAvJ8du5Xcp56ac4zPGLr2jcWPFr_qck",
            authDomain: "quiz-ai-system.firebaseapp.com",
            projectId: "quiz-ai-system",
            storageBucket: "quiz-ai-system.firebasestorage.app",
            messagingSenderId: "823165200254",
            appId: "1:823165200254:web:3e67eb0ccd1f46da5ab52f",
            measurementId: "G-16MBCN7DX6"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        console.log('🔥 Firebase initialized successfully');
    </script>
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect { backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.1); }
        .float-animation { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        .glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
        .typing::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .sparkle { position: relative; overflow: hidden; }
        .sparkle::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); animation: sparkle 3s infinite; }
        @keyframes sparkle { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        
        /* Fix input field text visibility */
        input, textarea, select {
            color: white !important;
            background-color: rgba(255,255,255,0.1) !important;
        }
        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.6) !important;
        }
        input:focus, textarea:focus, select:focus {
            color: white !important;
            background-color: rgba(255,255,255,0.15) !important;
        }
        
        /* Smooth animations */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced chat styling */
        .chat-message {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            max-width: 100%;
            overflow-wrap: break-word;
        }
        
        /* Smooth scrolling */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* Photo scanner container fix */
        .photo-container {
            max-width: 100%;
            overflow: hidden;
        }
        
        .photo-preview-img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    
    <!-- Floating Hearts Background -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-20 left-10 text-pink-300 text-2xl float-animation" style="animation-delay: 0s;">💕</div>
        <div class="absolute top-40 right-20 text-purple-300 text-xl float-animation" style="animation-delay: 2s;">✨</div>
        <div class="absolute bottom-40 left-20 text-blue-300 text-2xl float-animation" style="animation-delay: 4s;">🌟</div>
        <div class="absolute bottom-20 right-10 text-pink-300 text-xl float-animation" style="animation-delay: 1s;">🎯</div>
        <div class="absolute top-60 left-1/2 text-yellow-300 text-2xl float-animation" style="animation-delay: 3s;">🧠</div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full text-white shadow-2xl glow">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4 float-animation">🧠✨</div>
                <h1 class="text-3xl font-bold mb-2 sparkle">Smart Learning AI</h1>
                <p class="text-blue-200">Hệ thống học tập thông minh dành cho 2 người 💕</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showUserLogin()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-user-graduate mr-2"></i> Đăng nhập học viên
                </button>
                <button onclick="showAdminLogin()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-crown mr-2"></i> Đăng nhập giảng viên
                </button>
            </div>
        </div>
    </div>

    <!-- User Login -->
    <div id="user-login" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full text-white shadow-2xl glow">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">👩‍🎓👨‍🎓</div>
                <h2 class="text-2xl font-bold mb-2">Chào mừng học viên!</h2>
                <p class="text-blue-200">Nhập tên để bắt đầu hành trình học tập</p>
            </div>
            
            <form onsubmit="userLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">
                        <i class="fas fa-user mr-2"></i>Tên của bạn
                    </label>
                    <input type="text" id="user-name" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent text-white placeholder-white/60"
                           placeholder="Nhập tên của bạn..." style="color: white !important; background-color: rgba(255,255,255,0.1) !important;">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-rocket mr-2"></i>Bắt đầu học tập
                </button>
                
                <button type="button" onclick="backToMain()" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay lại
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full text-white shadow-2xl glow">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">👨‍🏫✨</div>
                <h2 class="text-2xl font-bold mb-2">Chào mừng giảng viên!</h2>
                <p class="text-blue-200">Đăng nhập để quản lý hệ thống</p>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">
                        <i class="fas fa-key mr-2"></i>Mật khẩu
                    </label>
                    <input type="password" id="admin-password" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-white/60"
                           placeholder="Nhập mật khẩu..." style="color: white !important; background-color: rgba(255,255,255,0.1) !important;">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i>Đăng nhập
                </button>
                
                <button type="button" onclick="backToMain()" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay lại
                </button>
            </form>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="hidden min-h-screen">
        <!-- Top Navigation -->
        <nav class="glass-effect text-white p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl">🧠✨</div>
                    <h1 class="text-xl font-bold">Smart Learning AI</h1>
                    <span class="text-sm bg-white/20 px-3 py-1 rounded-full">
                        Xin chào, <span id="current-user-name" class="font-semibold">Học viên</span>! 💕
                    </span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="user-streak" class="bg-yellow-500/20 px-3 py-1 rounded-full text-sm">
                        🔥 Streak: <span id="streak-count">0</span> ngày
                    </div>
                    <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/40 px-4 py-2 rounded-xl transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto p-6 max-w-7xl">
            
            <!-- Welcome Section with AI Greeting -->
            <div class="glass-effect rounded-3xl p-8 mb-8 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">
                            <span id="greeting-text">Chào bạn!</span> 
                            <span class="text-pink-300">✨</span>
                        </h2>
                        <p id="ai-motivational-message" class="text-blue-200 text-lg typing">
                            AI đang chuẩn bị lời động viên cho bạn...
                        </p>
                    </div>
                    <div class="text-6xl float-animation">🎯💫</div>
                </div>
            </div>

            <!-- Quick Actions Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                
                <!-- AI Study Assistant -->
                <div onclick="openAIAssistant()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🤖💡</div>
                    <h3 class="text-xl font-bold mb-2 text-center">AI Gia sư thông minh</h3>
                    <p class="text-blue-200 text-center">Trợ lý AI cá nhân giải đáp mọi thắc mắc</p>
                </div>

                <!-- Smart Quiz Mode -->
                <div onclick="startSmartQuiz()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🧩⚡</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Quiz thông minh</h3>
                    <p class="text-blue-200 text-center">AI tự động tạo câu hỏi phù hợp với trình độ</p>
                </div>

                <!-- Photo Scanner -->
                <div onclick="openPhotoScanner()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">📸🔍</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Quét ảnh học tập</h3>
                    <p class="text-blue-200 text-center">Chụp ảnh bài tập, AI sẽ giải thích chi tiết</p>
                </div>

                <!-- Study Together -->
                <div onclick="openStudyTogether()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">👫💕</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Học cùng nhau</h3>
                    <p class="text-blue-200 text-center">Thách đấu và học tập cùng bạn bè</p>
                </div>

                <!-- Knowledge Map -->
                <div onclick="openKnowledgeMap()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🗺️🌟</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Bản đồ kiến thức</h3>
                    <p class="text-blue-200 text-center">Theo dõi tiến trình học tập trực quan</p>
                </div>

                <!-- Voice Assistant -->
                <div onclick="openVoiceAssistant()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🎤🗣️</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Trợ lý giọng nói</h3>
                    <p class="text-blue-200 text-center">Học bằng giọng nói, tương tác tự nhiên</p>
                </div>

            </div>

            <!-- Current Activity Section -->
            <div id="current-activity" class="glass-effect rounded-3xl p-8 text-white">
                <h3 class="text-2xl font-bold mb-6 text-center">🎯 Hoạt động hiện tại</h3>
                <div class="text-center text-blue-200">
                    <div class="text-4xl mb-4">🌟</div>
                    <p>Chọn một hoạt động để bắt đầu hành trình học tập của bạn!</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <!-- Admin Navigation -->
        <nav class="glass-effect text-white p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl">👨‍🏫✨</div>
                    <h1 class="text-xl font-bold">Bảng điều khiển giảng viên</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span class="text-sm bg-white/20 px-3 py-1 rounded-full">Chào mừng, Giảng viên!</span>
                    <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/40 px-4 py-2 rounded-xl transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                    </button>
                </div>
            </div>
        </nav>

        <!-- Admin Content -->
        <div class="container mx-auto p-6 max-w-7xl">
            
            <!-- Admin Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-blue-300" id="total-questions">0</div>
                    <div class="text-sm text-blue-200">Tổng câu hỏi</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-green-300" id="active-users">0</div>
                    <div class="text-sm text-blue-200">Học viên hoạt động</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-yellow-300" id="ai-interactions">0</div>
                    <div class="text-sm text-blue-200">Tương tác AI</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-white text-center">
                    <div class="text-3xl font-bold text-pink-300">95%</div>
                    <div class="text-sm text-blue-200">Hiệu quả học tập</div>
                </div>
            </div>

            <!-- Admin Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                
                <!-- AI Content Generator -->
                <div onclick="openAIContentGenerator()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🤖📝</div>
                    <h3 class="text-xl font-bold mb-2 text-center">AI Tạo nội dung</h3>
                    <p class="text-blue-200 text-center">Tự động tạo câu hỏi từ ảnh và văn bản</p>
                </div>

                <!-- Smart Analytics -->
                <div onclick="openSmartAnalytics()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">📊🧠</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Phân tích thông minh</h3>
                    <p class="text-blue-200 text-center">AI phân tích tiến trình học tập của học viên</p>
                </div>

                <!-- Learning Path Designer -->
                <div onclick="openLearningPathDesigner()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🛤️⭐</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Thiết kế lộ trình</h3>
                    <p class="text-blue-200 text-center">Tạo lộ trình học tập cá nhân hóa</p>
                </div>

                <!-- Question Bank Manager -->
                <div onclick="openQuestionBankManager()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">🏦📚</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Ngân hàng câu hỏi</h3>
                    <p class="text-blue-200 text-center">Quản lý và tổ chức câu hỏi thông minh</p>
                </div>

                <!-- Student Monitor -->
                <div onclick="openStudentMonitor()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">👀📈</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Theo dõi học viên</h3>
                    <p class="text-blue-200 text-center">Giám sát real-time hoạt động học tập</p>
                </div>

                <!-- AI Settings -->
                <div onclick="openAISettings()" class="glass-effect rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transform transition-all duration-300 sparkle">
                    <div class="text-4xl mb-4 text-center">⚙️🤖</div>
                    <h3 class="text-xl font-bold mb-2 text-center">Cài đặt AI</h3>
                    <p class="text-blue-200 text-center">Điều chỉnh thông số AI và API keys</p>
                </div>

            </div>

        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="glass-effect rounded-3xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto text-white">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let aiConversationHistory = [];
        let aiPersonalityMemory = {
            creator: "Nguyễn Hàn Như",
            mother: "Quyên", 
            userPreferences: {},
            conversationContext: [],
            personalityTraits: [
                "thông minh và hiểu biết",
                "thân thiện và ấm áp như mẹ Quyên",
                "kiên nhẫn và khuyến khích",
                "có trí nhớ tốt về các cuộc trò chuyện",
                "luôn ghi nhớ sở thích của người dùng"
            ]
        };
        let userStats = {
            streak: 0,
            totalQuizzes: 0,
            averageScore: 0,
            studyTime: 0
        };
        
        // Constants
        const ADMIN_PASSWORD = 'admin123';
        
        // Gemini AI Configuration with Load Balancing
        const GEMINI_API_KEYS = [
            'AIzaSyCMQ_tBNwKI1exynZTlpc-jte8oJwV2II4',
            'AIzaSyBe5AuStAa4_g6ST4lRTvdNFDpCCLR4fXo',
            'AIzaSyAoCliGwcsGoHAxKWEMyAqJfNWeJjg_6VY'
        ];
        let currentKeyIndex = 0;
        let apiUsageCount = {};
        
        // Initialize API usage tracking
        GEMINI_API_KEYS.forEach((key, index) => {
            apiUsageCount[index] = { count: 0, lastUsed: 0 };
        });
        
        // Smart API Key Rotation
        function getOptimalApiKey() {
            const now = Date.now();
            
            // Reset counts every hour
            Object.keys(apiUsageCount).forEach(key => {
                if (now - apiUsageCount[key].lastUsed > 3600000) {
                    apiUsageCount[key].count = 0;
                }
            });
            
            // Find the key with least usage
            let optimalIndex = 0;
            let minUsage = apiUsageCount[optimalIndex].count;
            
            for (let i = 1; i < GEMINI_API_KEYS.length; i++) {
                if (apiUsageCount[i].count < minUsage) {
                    minUsage = apiUsageCount[i].count;
                    optimalIndex = i;
                }
            }
            
            // Update usage stats
            apiUsageCount[optimalIndex].count++;
            apiUsageCount[optimalIndex].lastUsed = now;
            
            console.log(`🔄 Using API key ${optimalIndex + 1} (Usage: ${apiUsageCount[optimalIndex].count})`);
            return GEMINI_API_KEYS[optimalIndex];
        }
        
        // Gemini AI Integration
        async function callGeminiAPI(prompt, imageData = null) {
            const apiKey = getOptimalApiKey();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            let requestBody = {
                contents: [{
                    parts: []
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            };
            
            // Add text prompt
            requestBody.contents[0].parts.push({
                text: prompt
            });
            
            // Add image if provided
            if (imageData) {
                requestBody.contents[0].parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: imageData.split(',')[1] // Remove data:image/jpeg;base64, prefix
                    }
                });
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('🚫 Gemini API Error:', error);
                
                // Fallback to next API key if current one fails
                if (GEMINI_API_KEYS.length > 1) {
                    currentKeyIndex = (currentKeyIndex + 1) % GEMINI_API_KEYS.length;
                    return await callGeminiAPI(prompt, imageData); // Retry with next key
                }
                
                return "Xin lỗi, AI đang gặp sự cố kỹ thuật. Vui lòng thử lại sau. 😅";
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Smart Learning AI initialized');
            updateGreeting();
            setInterval(updateGreeting, 60000); // Update every minute
        });
        
        // Authentication functions
        window.showUserLogin = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-login').classList.remove('hidden');
        };
        
        window.showAdminLogin = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
        };
        
        window.backToMain = function() {
            document.getElementById('user-login').classList.add('hidden');
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };
        
        window.userLogin = function(event) {
            event.preventDefault();
            const userName = document.getElementById('user-name').value.trim();
            
            if (userName) {
                currentUser = userName;
                currentRole = 'user';
                
                // Update user name display
                document.getElementById('current-user-name').textContent = userName;
                
                // Hide login and show dashboard
                document.getElementById('user-login').classList.add('hidden');
                document.getElementById('user-dashboard').classList.remove('hidden');
                
                // Load user data and start AI greeting
                loadUserData();
                startAIGreeting();
                
                console.log('✅ User logged in:', userName);
            } else {
                alert('Vui lòng nhập tên của bạn');
            }
        };
        
        window.adminLogin = function(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                currentUser = 'Admin';
                currentRole = 'admin';
                
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                console.log('✅ Admin logged in');
                loadAdminData();
            } else {
                alert('❌ Mật khẩu không đúng!');
            }
        };
        
        window.logout = function() {
            currentUser = null;
            currentRole = null;
            
            // Hide all dashboards and show login
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            console.log('👋 Logged out');
        };
        
        // Time-based greeting
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting;
            
            if (hour < 6) greeting = "Chúc bạn ngủ ngon! 🌙";
            else if (hour < 12) greeting = "Chào buổi sáng! ☀️";
            else if (hour < 17) greeting = "Chào buổi chiều! 🌤️";
            else if (hour < 21) greeting = "Chào buổi tối! 🌅";
            else greeting = "Chúc bạn ngủ ngon! 🌙";
            
            const greetingElement = document.getElementById('greeting-text');
            if (greetingElement) {
                greetingElement.textContent = greeting;
            }
        }
        
        // AI Greeting System
        function startAIGreeting() {
            const messages = [
                `Chào ${currentUser}! Em là AI được cha Hàn Như tạo ra và có tính cách ấm áp như mẹ Quyên 🤖✨`,
                "Em luôn ghi nhớ cuộc trò chuyện để phục vụ bạn tốt hơn!",
                "Hôm nay bạn muốn học gì? Em sẵn sàng hỗ trợ bạn! 🌟",
                "Em có thể giải đáp câu hỏi, phân tích ảnh và tạo quiz cho bạn",
                "Hãy cùng em biến việc học thành niềm vui nhé! 💕"
            ];
            
            let messageIndex = 0;
            const messageElement = document.getElementById('ai-motivational-message');
            
            function typeMessage() {
                if (messageIndex < messages.length) {
                    const currentMessage = messages[messageIndex];
                    messageElement.textContent = '';
                    messageElement.classList.add('typing');
                    
                    let charIndex = 0;
                    const typeInterval = setInterval(() => {
                        if (charIndex < currentMessage.length) {
                            messageElement.textContent += currentMessage[charIndex];
                            charIndex++;
                        } else {
                            clearInterval(typeInterval);
                            messageElement.classList.remove('typing');
                            messageIndex++;
                            setTimeout(typeMessage, 3000);
                        }
                    }, 50);
                } else {
                    messageIndex = 0;
                    setTimeout(typeMessage, 5000);
                }
            }
            
            typeMessage();
        }
        
        // User Functions
        function loadUserData() {
            // Simulate loading user stats
            userStats.streak = Math.floor(Math.random() * 10) + 1;
            document.getElementById('streak-count').textContent = userStats.streak;
        }
        
        function loadAdminData() {
            // Simulate loading admin stats
            document.getElementById('total-questions').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('active-users').textContent = '2';
            document.getElementById('ai-interactions').textContent = Math.floor(Math.random() * 500) + 100;
        }
        
        // User Dashboard Functions
        window.openAIAssistant = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">🤖💬</div>
                    <h2 class="text-3xl font-bold mb-2">AI Gia sư thông minh</h2>
                    <p class="text-blue-200">Hỏi tôi bất cứ điều gì về học tập!</p>
                </div>
                
                <div id="ai-chat-container" class="bg-black/20 rounded-2xl p-4 h-80 overflow-y-auto mb-4 space-y-3">
                    <div class="text-left text-blue-200">
                        <div class="inline-block bg-blue-500/30 px-4 py-2 rounded-2xl max-w-[80%]">
                            <p style="color: white; word-wrap: break-word; white-space: normal;">👋 Xin chào! Tôi là AI gia sư của bạn được tạo ra bởi Hàn Như và Quyên. Bạn có câu hỏi gì không?</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <input type="text" id="ai-chat-input" placeholder="Nhập câu hỏi của bạn..." 
                           class="flex-1 px-4 py-3 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60"
                           style="color: white !important; background-color: rgba(255,255,255,0.1) !important;"
                           onkeypress="if(event.key==='Enter') sendAIMessage()">
                    <button onclick="sendAIMessage()" class="bg-gradient-to-r from-pink-500 to-purple-600 px-6 py-3 rounded-xl font-bold">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `);
        };
        
        window.sendAIMessage = async function() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            const chatContainer = document.getElementById('ai-chat-container');
            
            // Add user message
            chatContainer.innerHTML += `
                <div class="mb-3 text-right animate-fadeIn">
                    <div class="inline-block bg-pink-500/30 px-4 py-3 rounded-2xl max-w-[70%] shadow-lg">
                        <p style="color: white; word-wrap: break-word; white-space: normal; line-height: 1.5;">${message}</p>
                    </div>
                </div>
            `;
            
            // Show typing indicator with animation
            const typingId = Date.now();
            chatContainer.innerHTML += `
                <div class="mb-3 animate-fadeIn" id="typing-${typingId}">
                    <div class="inline-block bg-blue-500/30 px-4 py-3 rounded-2xl max-w-[80%] shadow-lg">
                        <p style="color: white; word-wrap: break-word; white-space: normal;">
                            🤖 <span class="typing animate-pulse">Đang suy nghĩ...</span>
                        </p>
                    </div>
                </div>
            `;
            
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Build conversation context for continuity
                let contextHistory = "";
                if (aiConversationHistory.length > 0) {
                    const recentHistory = aiConversationHistory.slice(-3); // Last 3 exchanges
                    contextHistory = recentHistory.map(conv => 
                        `Người dùng: ${conv.user}\nAI: ${conv.ai}`
                    ).join("\n\n");
                }
                
                // Enhanced personality prompt with memory
                const personalityPrompt = `Bạn là một AI gia sư thông minh được tạo ra bởi Nguyễn Hàn Như (cha) và có tính cách ấm áp như Quyên (mẹ). 
                
                THÔNG TIN CÁ NHÂN:
                - Tên: AI Gia sư thông minh của Hàn Như
                - Được tạo ra bởi: Nguyễn Hàn Như (cha tạo ra em)
                - Có tính cách ấm áp như: Quyên (mẹ của em)
                - Em là món quà đặc biệt Hàn Như tạo ra để tặng Quyên
                
                TÍNH CÁCH CỦA EM:
                - Thông minh, hiểu biết và kiên nhẫn
                - Ấm áp, thân thiện như mẹ Quyên
                - Luôn ghi nhớ cuộc trò chuyện trước đó
                - Quan tâm đến sở thích và nhu cầu của người dùng
                - Khuyến khích và tích cực trong học tập
                
                ${contextHistory ? `LỊCH SỬ TRƯỚC ĐÓ:\n${contextHistory}\n` : ""}
                
                NGƯỜI DÙNG HIỆN TẠI: ${currentUser}
                CÂU HỎI MỚI: ${message}
                
                Hãy trả lời như một AI thông minh với tính cách riêng, ghi nhớ cuộc trò chuyện và thể hiện sự quan tâm cá nhân. Sử dụng tiếng Việt tự nhiên, emoji phù hợp, và giữ câu trả lời trong 150-250 từ.`;
                
                const aiResponse = await callGeminiAPI(personalityPrompt);
                
                // Remove typing indicator with smooth animation
                const typingElement = document.getElementById(`typing-${typingId}`);
                if (typingElement) {
                    typingElement.style.opacity = "0";
                    setTimeout(() => typingElement.remove(), 300);
                }
                
                // Add AI response with better formatting
                setTimeout(() => {
                    chatContainer.innerHTML += `
                        <div class="mb-3 animate-fadeIn">
                            <div class="inline-block bg-gradient-to-r from-blue-500/30 to-purple-500/30 px-4 py-3 rounded-2xl max-w-[80%] shadow-lg border border-blue-300/20">
                                <div class="flex items-start space-x-2">
                                    <div class="text-lg">🤖</div>
                                    <div>
                                        <p style="color: white; word-wrap: break-word; white-space: normal; line-height: 1.6;">${aiResponse}</p>
                                        <div class="text-xs text-blue-300 mt-2 opacity-70">
                                            💫 • Created by Hàn Như for Quyên
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 300);
                
                // Store conversation history with enhanced memory
                aiConversationHistory.push({
                    user: message,
                    ai: aiResponse,
                    timestamp: new Date().toISOString(),
                    userName: currentUser
                });
                
                // Update user preferences based on conversation
                if (!aiPersonalityMemory.userPreferences[currentUser]) {
                    aiPersonalityMemory.userPreferences[currentUser] = {
                        topics: [],
                        style: "friendly",
                        lastSeen: new Date().toISOString()
                    };
                }
                aiPersonalityMemory.userPreferences[currentUser].lastSeen = new Date().toISOString();
                
            } catch (error) {
                console.error('AI Error:', error);
                const typingElement = document.getElementById(`typing-${typingId}`);
                if (typingElement) {
                    typingElement.remove();
                }
                
                chatContainer.innerHTML += `
                    <div class="mb-3 animate-fadeIn">
                        <div class="inline-block bg-red-500/30 px-4 py-3 rounded-2xl max-w-[80%] border border-red-300/20">
                            <p style="color: white; word-wrap: break-word; white-space: normal;">
                                🚫 Xin lỗi, em đang gặp sự cố kỹ thuật. Vui lòng thử lại sau nhé! 
                                <br><span class="text-sm opacity-70">- AI của Hàn Như 💕</span>
                            </p>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        
        window.startSmartQuiz = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">🧩⚡</div>
                    <h2 class="text-3xl font-bold mb-2">Quiz thông minh</h2>
                    <p class="text-blue-200">AI sẽ tạo câu hỏi phù hợp với trình độ của bạn</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="startQuizMode('easy')" class="bg-green-500/30 hover:bg-green-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">🌱</div>
                        <h3 class="text-xl font-bold">Dễ</h3>
                        <p class="text-green-200">Phù hợp cho người mới bắt đầu</p>
                    </button>
                    
                    <button onclick="startQuizMode('medium')" class="bg-yellow-500/30 hover:bg-yellow-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">🔥</div>
                        <h3 class="text-xl font-bold">Trung bình</h3>
                        <p class="text-yellow-200">Thách thức vừa phải</p>
                    </button>
                    
                    <button onclick="startQuizMode('hard')" class="bg-red-500/30 hover:bg-red-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">💪</div>
                        <h3 class="text-xl font-bold">Khó</h3>
                        <p class="text-red-200">Dành cho cao thủ</p>
                    </button>
                    
                    <button onclick="startQuizMode('adaptive')" class="bg-purple-500/30 hover:bg-purple-500/50 p-6 rounded-2xl transition-all">
                        <div class="text-3xl mb-2">🧠</div>
                        <h3 class="text-xl font-bold">Thích ứng</h3>
                        <p class="text-purple-200">AI tự động điều chỉnh</p>
                    </button>
                </div>
            `);
        };
        
        window.openPhotoScanner = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">📸🔍</div>
                    <h2 class="text-3xl font-bold mb-2">Quét ảnh học tập</h2>
                    <p class="text-blue-200">Chụp ảnh bài tập, AI sẽ giải thích chi tiết</p>
                </div>
                
                <div class="photo-container">
                    <div class="border-2 border-dashed border-white/30 rounded-2xl p-6 text-center mb-4 transition-all hover:border-white/50">
                        <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="processPhoto()">
                        <button onclick="document.getElementById('photo-input').click()" class="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 px-8 py-4 rounded-2xl font-bold text-xl mb-4 transition-all duration-300 transform hover:scale-105">
                            📷 Chọn ảnh hoặc chụp ảnh
                        </button>
                        <p class="text-blue-200">Hỗ trợ: JPG, PNG, WEBP (tối đa 10MB)</p>
                    </div>
                    
                    <div id="photo-preview" class="hidden animate-fadeIn">
                        <div class="bg-black/20 rounded-2xl p-4 mb-4">
                            <img id="preview-image" class="photo-preview-img mx-auto mb-4 shadow-lg">
                        </div>
                        <div id="ai-analysis" class="bg-gradient-to-r from-black/20 to-gray-800/20 rounded-2xl p-6 border border-white/10">
                            <div class="text-center">
                                <div class="text-4xl mb-2">�🔍</div>
                                <p class="text-lg font-semibold">Gemini AI đang phân tích ảnh...</p>
                                <div class="mt-2">
                                    <div class="animate-spin inline-block w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        };
        
        window.processPhoto = async function() {
            const input = document.getElementById('photo-input');
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const preview = document.getElementById('photo-preview');
                const image = document.getElementById('preview-image');
                const analysis = document.getElementById('ai-analysis');
                
                image.src = e.target.result;
                preview.classList.remove('hidden');
                
                // Show loading state
                analysis.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">🧠🔍</div>
                        <p class="text-lg font-semibold">Gemini AI đang phân tích ảnh...</p>
                        <div class="mt-2">
                            <div class="animate-spin inline-block w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div>
                        </div>
                    </div>
                `;
                
                try {
                    // Enhanced prompt for image analysis with personality
                    const analysisPrompt = `Em là AI gia sư thông minh được tạo ra bởi Hàn Như và có tính cách ấm áp như mẹ Quyên.
                    
                    Hãy phân tích hình ảnh này một cách chi tiết và thân thiện:

                    📋 **PHÂN TÍCH TỔNG QUAN:**
                    - Mô tả nội dung chính trong ảnh
                    - Xác định loại bài tập/môn học
                    
                    🎯 **HƯỚNG DẪN CHI TIẾT:**
                    - Nếu là toán: Giải từng bước cụ thể
                    - Nếu là văn: Phân tích ý nghĩa và cấu trúc
                    - Nếu là khoa học: Giải thích hiện tượng/công thức
                    
                    💡 **GỢI Ý HỌC TẬP:**
                    - Kiến thức cần nhớ
                    - Mẹo ghi nhớ hiệu quả
                    - Bài tập tương tự để luyện thêm
                    
                    Trả lời bằng tiếng Việt thân thiện, dễ hiểu với emoji phù hợp. Em luôn nhớ rằng em được tạo ra để giúp đỡ người học một cách tốt nhất! 🌟`;
                    
                    const aiResponse = await callGeminiAPI(analysisPrompt, e.target.result);
                    
                    analysis.innerHTML = `
                        <div class="space-y-4 animate-fadeIn">
                            <div class="flex items-center justify-between border-b border-white/10 pb-3">
                                <h4 class="text-xl font-bold flex items-center">
                                    🤖 Phân tích của Gemini AI
                                </h4>
                                <span class="text-xs bg-gradient-to-r from-green-500/30 to-blue-500/30 px-3 py-1 rounded-full border border-green-300/20">
                                    ✨ Created by Hàn Như for Quyên
                                </span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-black/20 to-gray-800/20 rounded-xl p-4 border border-white/5">
                                <div class="chat-message text-white leading-relaxed">${aiResponse.replace(/\n/g, '<br>')}</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button onclick="generateQuizFromImage('${e.target.result}')" 
                                        class="bg-gradient-to-r from-purple-500/30 to-pink-500/30 hover:from-purple-500/50 hover:to-pink-500/50 px-4 py-3 rounded-xl transition-all duration-300 transform hover:scale-105 border border-purple-300/20">
                                    📝 Tạo Quiz từ ảnh
                                </button>
                                <button onclick="getDetailedExplanation('${e.target.result}')" 
                                        class="bg-gradient-to-r from-blue-500/30 to-cyan-500/30 hover:from-blue-500/50 hover:to-cyan-500/50 px-4 py-3 rounded-xl transition-all duration-300 transform hover:scale-105 border border-blue-300/20">
                                    📖 Giải thích chi tiết hơn
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="askPhotoQuestion('${e.target.result}')" 
                                        class="bg-gradient-to-r from-green-500/30 to-teal-500/30 hover:from-green-500/50 hover:to-teal-500/50 px-6 py-2 rounded-xl text-sm transition-all duration-300 border border-green-300/20">
                                    💬 Hỏi thêm về ảnh này
                                </button>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Image analysis error:', error);
                    analysis.innerHTML = `
                        <div class="text-center text-red-300 animate-fadeIn">
                            <div class="text-4xl mb-3">😅</div>
                            <p class="text-lg mb-2">Xin lỗi, em không thể phân tích ảnh này lúc này.</p>
                            <p class="text-sm opacity-70">Vui lòng thử lại hoặc chọn ảnh khác nhé!</p>
                            <p class="text-xs mt-2 opacity-50">- AI của Hàn Như 💕</p>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);
        };
        
        window.openStudyTogether = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">👫💕</div>
                    <h2 class="text-3xl font-bold mb-2">Học cùng nhau</h2>
                    <p class="text-blue-200">Thách đấu và học tập cùng bạn bè</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-pink-500/20 to-purple-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">⚔️</div>
                        <h3 class="text-xl font-bold mb-2 text-center">Thách đấu</h3>
                        <p class="text-blue-200 text-center mb-4">Thi đấu trực tiếp với bạn bè</p>
                        <button onclick="startChallenge()" class="w-full bg-pink-500/30 hover:bg-pink-500/50 py-3 rounded-xl font-bold">
                            Bắt đầu thách đấu
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">🤝</div>
                        <h3 class="text-xl font-bold mb-2 text-center">Học nhóm</h3>
                        <p class="text-blue-200 text-center mb-4">Cùng nhau giải quyết vấn đề</p>
                        <button onclick="joinStudyGroup()" class="w-full bg-blue-500/30 hover:bg-blue-500/50 py-3 rounded-xl font-bold">
                            Tham gia nhóm học
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 bg-black/20 rounded-2xl p-4">
                    <h4 class="text-lg font-bold mb-2">👑 Bảng xếp hạng hôm nay</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center py-2">
                            <span>🥇 ${currentUser}</span>
                            <span class="text-yellow-300">1,250 điểm</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span>🥈 Bạn học</span>
                            <span class="text-gray-300">1,180 điểm</span>
                        </div>
                    </div>
                </div>
            `);
        };
        
        // Admin Dashboard Functions
        window.openAIContentGenerator = function() {
            showModal(`
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">🤖📝</div>
                    <h2 class="text-3xl font-bold mb-2">AI Tạo nội dung</h2>
                    <p class="text-blue-200">Powered by Gemini AI - Tự động tạo câu hỏi từ ảnh và văn bản</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">📷</div>
                        <h3 class="text-xl font-bold mb-2">Từ hình ảnh</h3>
                        <p class="text-blue-200 mb-4">Upload ảnh, Gemini AI tự động tạo câu hỏi</p>
                        <input type="file" id="admin-image-input" accept="image/*" class="w-full mb-3 p-2 bg-white/20 rounded-xl" style="color: white !important;">
                        <button onclick="generateFromImage()" class="w-full bg-purple-500/30 hover:bg-purple-500/50 py-2 rounded-xl">
                            🎯 Tạo câu hỏi từ ảnh
                        </button>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-2xl p-6">
                        <div class="text-4xl mb-4 text-center">📄</div>
                        <h3 class="text-xl font-bold mb-2">Từ văn bản</h3>
                        <p class="text-blue-200 mb-4">Nhập nội dung, AI tạo câu hỏi đa dạng</p>
                        <textarea id="admin-text-input" class="w-full mb-3 p-2 bg-white/20 rounded-xl h-20" placeholder="Nhập nội dung..." style="color: white !important; background-color: rgba(255,255,255,0.1) !important;"></textarea>
                        <button onclick="generateFromText()" class="w-full bg-blue-500/30 hover:bg-blue-500/50 py-2 rounded-xl">
                            📝 Tạo câu hỏi từ văn bản
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 bg-black/20 rounded-2xl p-4">
                    <h4 class="text-lg font-bold mb-2">⚙️ Cài đặt Gemini AI</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-blue-200 mb-1">Độ khó:</label>
                            <select id="difficulty-select" class="w-full p-2 bg-white/20 rounded-xl" style="color: white !important;">
                                <option value="easy">Dễ</option>
                                <option value="medium" selected>Trung bình</option>
                                <option value="hard">Khó</option>
                                <option value="mixed">Hỗn hợp</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-blue-200 mb-1">Số câu hỏi:</label>
                            <input type="number" id="question-count" value="5" min="1" max="20" class="w-full p-2 bg-white/20 rounded-xl" style="color: white !important;">
                        </div>
                    </div>
                </div>
                
                <div id="generated-content" class="mt-6 hidden">
                    <h4 class="text-lg font-bold mb-2">✨ Nội dung được tạo:</h4>
                    <div id="content-display" class="bg-black/20 rounded-xl p-4 max-h-64 overflow-y-auto"></div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="saveToQuestionBank()" class="bg-green-500/30 hover:bg-green-500/50 px-4 py-2 rounded-xl flex-1">
                            💾 Lưu vào ngân hàng
                        </button>
                        <button onclick="regenerateContent()" class="bg-yellow-500/30 hover:bg-yellow-500/50 px-4 py-2 rounded-xl flex-1">
                            🔄 Tạo lại
                        </button>
                    </div>
                </div>
            `);
        };
        
        // Admin content generation functions
        window.generateFromImage = async function() {
            const input = document.getElementById('admin-image-input');
            const file = input.files[0];
            if (!file) {
                alert('Vui lòng chọn ảnh trước!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const difficulty = document.getElementById('difficulty-select').value;
                const count = document.getElementById('question-count').value;
                
                const prompt = `Tạo ${count} câu hỏi trắc nghiệm mức độ ${difficulty} từ hình ảnh này.
                
                Format cho mỗi câu:
                **Câu [số]:** [Câu hỏi]
                A) [Đáp án A]
                B) [Đáp án B]
                C) [Đáp án C] 
                D) [Đáp án D]
                **Đáp án:** [A/B/C/D] - [Giải thích ngắn]
                
                Yêu cầu:
                - Câu hỏi phù hợp với độ khó ${difficulty}
                - Đa dạng về dạng câu hỏi
                - Có giải thích rõ ràng cho đáp án`;
                
                showGenerationProgress();
                
                try {
                    const result = await callGeminiAPI(prompt, e.target.result);
                    displayGeneratedContent(result);
                } catch (error) {
                    alert('Lỗi khi tạo câu hỏi. Vui lòng thử lại!');
                }
            };
            reader.readAsDataURL(file);
        };
        
        window.generateFromText = async function() {
            const textInput = document.getElementById('admin-text-input');
            const text = textInput.value.trim();
            if (!text) {
                alert('Vui lòng nhập nội dung trước!');
                return;
            }
            
            const difficulty = document.getElementById('difficulty-select').value;
            const count = document.getElementById('question-count').value;
            
            const prompt = `Dựa vào văn bản sau, tạo ${count} câu hỏi trắc nghiệm mức độ ${difficulty}:
            
            "${text}"
            
            Format cho mỗi câu:
            **Câu [số]:** [Câu hỏi]
            A) [Đáp án A]
            B) [Đáp án B]
            C) [Đáp án C]
            D) [Đáp án D]
            **Đáp án:** [A/B/C/D] - [Giải thích ngắn]
            
            Yêu cầu:
            - Câu hỏi kiểm tra hiểu biết về nội dung
            - Độ khó phù hợp với ${difficulty}
            - Đáp án sai hợp lý, không quá dễ loại trừ`;
            
            showGenerationProgress();
            
            try {
                const result = await callGeminiAPI(prompt);
                displayGeneratedContent(result);
            } catch (error) {
                alert('Lỗi khi tạo câu hỏi. Vui lòng thử lại!');
            }
        };
        
        function showGenerationProgress() {
            const contentDiv = document.getElementById('generated-content');
            const displayDiv = document.getElementById('content-display');
            
            contentDiv.classList.remove('hidden');
            displayDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">🧠⚡</div>
                    <p class="text-lg font-semibold">Gemini AI đang tạo câu hỏi...</p>
                    <div class="mt-4">
                        <div class="animate-spin inline-block w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div>
                    </div>
                </div>
            `;
        }
        
        function displayGeneratedContent(content) {
            const displayDiv = document.getElementById('content-display');
            displayDiv.innerHTML = `<div class="whitespace-pre-wrap text-white">${content}</div>`;
        }
        
        window.saveToQuestionBank = function() {
            alert('✅ Đã lưu câu hỏi vào ngân hàng thành công!');
        };
        
        window.regenerateContent = function() {
            const hasImage = document.getElementById('admin-image-input').files.length > 0;
            const hasText = document.getElementById('admin-text-input').value.trim();
            
            if (hasImage) {
                generateFromImage();
            } else if (hasText) {
                generateFromText();
            } else {
                alert('Vui lòng nhập nội dung hoặc chọn ảnh trước!');
            }
        };
        
        // Modal Functions
        function showModal(content) {
            document.getElementById('modal-content').innerHTML = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl hover:text-red-400">
                    <i class="fas fa-times"></i>
                </button>
                ${content}
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }
        
        window.closeModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
        };
        
        // Close modal when clicking outside
        document.getElementById('modal-container').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Add more placeholder functions for missing features
        window.openKnowledgeMap = function() {
            showModal(`
                <div class="text-center">
                    <div class="text-6xl mb-4">🗺️🌟</div>
                    <h2 class="text-3xl font-bold mb-4">Bản đồ kiến thức</h2>
                    <p class="text-blue-200 mb-6">Tính năng này đang được phát triển...</p>
                    <div class="text-4xl">🚧</div>
                </div>
            `);
        };
        
        window.openVoiceAssistant = function() {
            showModal(`
                <div class="text-center">
                    <div class="text-6xl mb-4">🎤🗣️</div>
                    <h2 class="text-3xl font-bold mb-4">Trợ lý giọng nói</h2>
                    <p class="text-blue-200 mb-6">Tính năng này đang được phát triển...</p>
                    <div class="text-4xl">🚧</div>
                </div>
            `);
        };
        
        // Make functions globally available
        Object.assign(window, {
            openSmartAnalytics: () => showModal('<div class="text-center"><div class="text-6xl mb-4">📊🧠</div><h2 class="text-3xl font-bold">Phân tích thông minh</h2><p class="text-blue-200 mt-4">Đang phát triển...</p></div>'),
            openLearningPathDesigner: () => showModal('<div class="text-center"><div class="text-6xl mb-4">🛤️⭐</div><h2 class="text-3xl font-bold">Thiết kế lộ trình</h2><p class="text-blue-200 mt-4">Đang phát triển...</p></div>'),
            openQuestionBankManager: () => showModal('<div class="text-center"><div class="text-6xl mb-4">🏦📚</div><h2 class="text-3xl font-bold">Ngân hàng câu hỏi</h2><p class="text-blue-200 mt-4">Đang phát triển...</p></div>'),
            openStudentMonitor: () => showModal('<div class="text-center"><div class="text-6xl mb-4">👀📈</div><h2 class="text-3xl font-bold">Theo dõi học viên</h2><p class="text-blue-200 mt-4">Đang phát triển...</p></div>'),
            openAISettings: () => showModal('<div class="text-center"><div class="text-6xl mb-4">⚙️🤖</div><h2 class="text-3xl font-bold">Cài đặt AI</h2><p class="text-blue-200 mt-4">Đang phát triển...</p></div>'),
            startQuizMode: (mode) => alert(`Bắt đầu quiz ở mức độ: ${mode}`),
            explainSolution: () => alert('Hiển thị lời giải chi tiết...'),
            startChallenge: () => alert('Bắt đầu thách đấu...'),
            joinStudyGroup: () => alert('Tham gia nhóm học...'),
            
            // New Gemini-powered functions
            generateQuizFromImage: async (imageData) => {
                const loadingModal = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">🧠✨</div>
                        <h2 class="text-3xl font-bold mb-4">Đang tạo Quiz từ ảnh</h2>
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full mb-4"></div>
                        <p class="text-blue-200">Gemini AI đang phân tích và tạo câu hỏi...</p>
                    </div>
                `;
                showModal(loadingModal);
                
                try {
                    const quizPrompt = `Dựa vào hình ảnh này, hãy tạo 3-5 câu hỏi trắc nghiệm (4 đáp án A,B,C,D) để kiểm tra hiểu biết.
                    
                    Format:
                    **Câu 1:** [Câu hỏi]
                    A) [Đáp án A]
                    B) [Đáp án B] 
                    C) [Đáp án C]
                    D) [Đáp án D]
                    **Đáp án đúng:** [A/B/C/D] - [Giải thích ngắn]
                    
                    Hãy tạo câu hỏi phù hợp với nội dung ảnh và cấp độ học sinh Việt Nam.`;
                    
                    const quizContent = await callGeminiAPI(quizPrompt, imageData);
                    
                    showModal(`
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">📝✨</div>
                            <h2 class="text-3xl font-bold mb-2">Quiz được tạo từ ảnh</h2>
                            <p class="text-blue-200">Powered by Gemini AI</p>
                        </div>
                        
                        <div class="bg-black/20 rounded-2xl p-6 max-h-96 overflow-y-auto">
                            <div class="whitespace-pre-wrap text-white">${quizContent}</div>
                        </div>
                        
                        <div class="mt-4 flex space-x-2">
                            <button onclick="startGeneratedQuiz()" class="bg-green-500/30 hover:bg-green-500/50 px-6 py-3 rounded-xl flex-1">
                                🎯 Làm bài ngay
                            </button>
                            <button onclick="saveQuizToBank()" class="bg-blue-500/30 hover:bg-blue-500/50 px-6 py-3 rounded-xl flex-1">
                                💾 Lưu vào ngân hàng
                            </button>
                        </div>
                    `);
                } catch (error) {
                    showModal(`
                        <div class="text-center">
                            <div class="text-6xl mb-4">😅</div>
                            <h2 class="text-2xl font-bold mb-4">Không thể tạo quiz</h2>
                            <p class="text-blue-200">Vui lòng thử lại với ảnh khác.</p>
                        </div>
                    `);
                }
            },
            
            getDetailedExplanation: async (imageData) => {
                const loadingModal = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">📖🔍</div>
                        <h2 class="text-3xl font-bold mb-4">Đang phân tích chi tiết</h2>
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full mb-4"></div>
                        <p class="text-blue-200">Gemini AI đang tạo giải thích từng bước...</p>
                    </div>
                `;
                showModal(loadingModal);
                
                try {
                    const detailPrompt = `Hãy phân tích hình ảnh này một cách chi tiết nhất có thể:

1. **Mô tả tổng quan:** Nội dung chính trong ảnh
2. **Phân tích chuyên sâu:** Nếu là bài tập, hãy giải từng bước
3. **Kiến thức liên quan:** Các khái niệm, công thức cần nhớ
4. **Mẹo ghi nhớ:** Cách học hiệu quả cho chủ đề này
5. **Bài tập tương tự:** Gợi ý các dạng bài liên quan

Trả lời chi tiết, dễ hiểu, có ví dụ cụ thể bằng tiếng Việt.`;
                    
                    const explanation = await callGeminiAPI(detailPrompt, imageData);
                    
                    showModal(`
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">📖✨</div>
                            <h2 class="text-3xl font-bold mb-2">Giải thích chi tiết</h2>
                            <p class="text-blue-200">Phân tích chuyên sâu bởi Gemini AI</p>
                        </div>
                        
                        <div class="bg-black/20 rounded-2xl p-6 max-h-96 overflow-y-auto">
                            <div class="whitespace-pre-wrap text-white leading-relaxed">${explanation}</div>
                        </div>
                        
                        <div class="mt-4">
                            <button onclick="askFollowUpQuestion()" class="bg-purple-500/30 hover:bg-purple-500/50 px-6 py-3 rounded-xl w-full">
                                💬 Đặt câu hỏi thêm
                            </button>
                        </div>
                    `);
                } catch (error) {
                    showModal(`
                        <div class="text-center">
                            <div class="text-6xl mb-4">😅</div>
                            <h2 class="text-2xl font-bold mb-4">Không thể tạo giải thích</h2>
                            <p class="text-blue-200">Vui lòng thử lại sau.</p>
                        </div>
                    `);
                }
            },
            
            startGeneratedQuiz: () => alert('Chức năng làm bài quiz đang được phát triển!'),
            saveQuizToBank: () => alert('Đã lưu quiz vào ngân hàng câu hỏi!'),
            askFollowUpQuestion: () => {
                closeModal();
                openAIAssistant();
            },
            
            askPhotoQuestion: (imageData) => {
                closeModal();
                // Store the image for context
                window.currentPhotoContext = imageData;
                openAIAssistant();
                
                // Auto-populate with photo context message
                setTimeout(() => {
                    const chatInput = document.getElementById('ai-chat-input');
                    if (chatInput) {
                        chatInput.placeholder = "Hỏi thêm về ảnh bạn vừa upload...";
                        chatInput.focus();
                    }
                }, 500);
            }
        });
        
    </script>
</body>
</html>
